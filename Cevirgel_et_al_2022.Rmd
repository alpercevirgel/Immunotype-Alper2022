---
title: "Chapter 1" author: "Alper" 
date: "12/07/2022" 
output: html_document
---

# libraries & functions
```{r}
source("codes/libraries.R") #load the libraries
source("codes/functions.R") #load the functions
```

# Influenza pre-vaccination Data import
## create directory
```{r }
## set working directory
analysis.path <- getwd()

## create output folders
dir.create(file.path(analysis.path, "results"), showWarnings = FALSE) #for all results
dir.create(file.path(analysis.path, "results/figures"), showWarnings = FALSE) #for figures
dir.create(file.path(analysis.path, "results/tables"), showWarnings = FALSE) #for tables
```

## import data
### sample and subject identifier, assay type, sample type
```{r }
## import data, contains collection day, assay type, sample type
vital.sample <- read_excel("VITAL_database.xlsx",
                           sheet = "sample_collection_date_FACS",
                           skip = 1) %>% 
  mutate_at(c("subject_identifier"), list(~as.character(.))) %>% 
  as.data.frame()

head(vital.sample) #quick look at the imported data
```

### influenza vaccination trucount data, age and timepoint
```{r }
## import data, contains the influenza vaccination trucount data, age, timepoint 
vital.truc_influ <- read_excel("VITAL_database.xlsx",
                               sheet = "trucount_influenza_vac",
                               skip = 1) %>% 
  mutate_at(c("sex","age_group","timepoint","timepoint_days"), list(~factor(.))) %>%
  mutate_at(c("subject_identifier"), list(~as.character(.))) %>%
  as.data.frame()

head(vital.truc_influ) #quick look at the imported data
```

### subsetting baseline data and selecting 59 non-overlapping immune cell subset percentages for PCA and clustering
```{r }
## Subsetting baseline data
vital.truc_influ_d0 <- vital.truc_influ %>% filter(timepoint_days %in%  "Day 0")

## assign subject identifier as rownames
rownames(vital.truc_influ_d0) <- vital.truc_influ_d0$subject_identifier
head(vital.truc_influ_d0)

## remove the variables that are not immune parameters
vital.truc_influ_d0_immvar <- as.data.frame(vital.truc_influ_d0[,-c(1:8),])
head(vital.truc_influ_d0_immvar) #must start with immune parameters in the first column

##### manually selected 59 non-overlapping immune subsets for PCA and clustering analysis ####
vital.truc_influ_d0_immvar_sel <- vital.truc_influ_d0_immvar %>%
  select(granulocytes_per,
         lymphocytes_per,
         `CD3+_per`,
         `CD4+_per`,
         `CD4_Tcm_per`,
         `CD4_Tem_per`,
         `CD4_Teff_per`,
         `CD4_TrueNaive_per`,
         `CD4_Tscm_per`,
         `CD4_Treg_per`,
         `CD4_Treg_Tcm_per`,
         `CD4_Treg_Tem_per`,
         `CD4_Treg_Tn_per`,
         `CD4_Treg_CD38+_per`,
         `CD4_Treg_HLADR+_per`,
         `CD4_Treg_CD95+_per`,
         `CD4_CD38+_per`,
         `CD4_CD38+HLADR+_per`,
         `CD4_HLADR+_per`,
         `CD4_CD95+_per`,
         `CD4_CXCR5+_per`,
         `CD4_CXCR5+CD38+_per`,
         `CD4_CXCR5+CD38-HLADR-_per`,
         `CD4_CXCR5+CD95+_per`,
         `CD4_CXCR5+_Tcm_per`,
         `CD4_CXCR5+_Tem_per`,
         `CD4_CXCR5+_Tn_per`,
         `CD8+_per`,
         `CD8_Tcm_per`,
         `CD8_Tem_per`,
         `CD8_Teff_per`,
         `CD8_TrueNaive_per`,
         `CD8_Tscm_per`,
         `CD8_CD38+_per`,
         `CD8_CD38+HLADR+_per`,
         `CD8_HLADR+_per`,
         `CD8_CD95+_per`,
         `CD8_CXCR5+_per`,
         `CD8_CXCR5+CD95+_per`,
         `CD8_CXCR5+_Tcm_per`,
         `CD8_CXCR5+_Tem_per`,
         `CD8_CXCR5+_Tn_per`,
         `CD8_CXCR5+_Teff_per`,
         `CD3-_per`,
         `CD56bright_per`,
         `CD56bright_CD38+_per`,
         `CD56dim_per`,
         `CD56dim_CD38+_per`,
         `CD56neg_per`,
         `CD56neg_HLADR+_per`,
         `CD19+_per`,
         `B_DN_memory_IgD-CD27-_per`,
         `B_memory_IgD+CD27+_per`,
         `B_naive_IgD+CD27-_per`,
         `B_switched_memory_IgD-CD27+_per`,
         `monocytes_per`,
         `monocytes_classical_per`,
         `monocytes_intermediate_per`,
         `monocytes_nonclassical_per`)
#####
## check the dimensions of the dataset
dim(vital.truc_influ_d0_immvar_sel)
```

### chronic herpes virus infection data and creating factors for CMV-EBV seropositivity combinations
```{r }
## add chronic herpes virus infection data, and create factors for CMV+/- & EBV+/- combinations
## 1 = positive, 2= negative, 3=borderline
chronic_viral_inf <- read_excel("VITAL_database.xlsx", 
                                sheet = "CMV_EBV_VZV",
                                skip = 1,
                                na = "n/a") %>%
  select(subject_identifier,MIA_CMV_Titer,MIA_CMV_Seropositivity,MIA_EBV_Titer,MIA_EBV_Seropositivity,MIA_VZV_Titer,MIA_VZV_Seropositivity) %>%
  mutate(CMV_EBV_combined = case_when(
    MIA_CMV_Seropositivity == "1" & MIA_EBV_Seropositivity == "1"  ~ "CMV+EBV+",
    MIA_CMV_Seropositivity == "2" & MIA_EBV_Seropositivity == "2"  ~ "CMV-EBV-",
    MIA_CMV_Seropositivity == "3" | MIA_EBV_Seropositivity == "3"  ~ "Borderline",
    MIA_CMV_Seropositivity == "1" & MIA_EBV_Seropositivity == "2"  ~ "CMV+EBV-",
    MIA_CMV_Seropositivity == "2" & MIA_EBV_Seropositivity == "1"  ~ "CMV-EBV+",
  ),.after="subject_identifier") %>%
  mutate_at(c("subject_identifier"), list(~as.character(.))) %>%
  mutate_at(c("MIA_CMV_Seropositivity","MIA_EBV_Seropositivity","MIA_VZV_Seropositivity","CMV_EBV_combined"), list(~factor(.)))

head(chronic_viral_inf)
```

### DxH 500 Hematology Analyzer data
```{r }
## adding immunological data from DxH 500 Hematology Analyzer
beckman_coulter_d0 <- read_excel("VITAL_database.xlsx",
                                 sheet = "DxH500",
                                 skip = 1, 
                                 na = "n/a") %>% 
  filter(grepl("A", sample_identifier)) %>% select(-sample_identifier,-assay_title) %>% #select Day 0 data
  mutate_at(c("subject_identifier"),list(~as.character(.))) %>%
  dplyr::rename(RBC=`RBC red blood cell (x10^12/L)`, #renaming immune variables since special characters creates problems in R
                WBC=`WBC white blood cell`,
                HGB=`HGB hemoglobulin (mmol/L)`,
                LY_num=`LY# lymphocyte absolute number (x10^9/L)`,
                MO_num=`MO# monocyte absolute number (x10^9/L)`,
                NE_num=`NE# neutrophil absolute number (x10^9/L)`,
                EO_num=`EO# eosinophil absolute number (x10^9/L)`,
                BA_num=`BA# basophil absolute number (x10^9/L)`,
                HCT=`HCT hematocrit (L/L)`,
                MCV=`MCV mean cell volume (fL)`,
                MCH=`MCH mean corpuscular hemoglobin (fmol)`,
                MCHC=`MCHC mean corpuscular hemoglobin concentration (mmol/L)`,
                RDW=`RDW red cell distribution width (%)`,
                RDWSD=`RDWSD red cell distribution width - SD (fL)`,
                LY_per=`LY lymphocyte percentage (%)`,
                MO_per=`MO monocyte percentage (%)`,
                NE_per=`NE neutrophil percentage (%)`,
                EO_per=`EO eosinophil percentage (%)`,
                BA_per=`BA basophil percentage (%)`,
                PLT=`PLT platelet`,
                MPV=`MPV mean platelet volume`)
```


# Outlier detection & removal
## create directory
```{r}
## create output directory
dir.create(file.path(analysis.path, "results/figures/outlier_cooks"), showWarnings = FALSE)
```

## outlier detection
```{r}
## Cooks distance (Loop for all variables)
## remove outliers based on the following immune subset populations
outlier_checks_variables <- c("CD19+_per","CD3-_per","CD3+_per","CD4+_per","CD8+_per","granulocytes_per","lymphocytes_per"	,"monocytes_per")
outlier_list <- c() #creating an empty list

## loop to remove outliers and save the plots. cooksd 15 is used
for (i in outlier_checks_variables) {
  Variable <- vital.truc_influ_d0_immvar_sel[[i]]
  y_title <- i

  mod <- lm( Variable ~ ., data=vital.truc_influ_d0_immvar_sel)
  cooksd <- cooks.distance(mod)

  plot(cooksd, pch="*", cex=1, main=sprintf("Influential Obs %s",y_title))
  abline(h = 15*mean(cooksd, na.rm=T), col="red")
  text(x=1:length(cooksd)+1, y=cooksd,labels=ifelse(cooksd>15*mean(cooksd, na.rm=T),names(cooksd),""), col="red")

  dev.print(pdf, file = sprintf("results/figures/outlier_cooks/Outlier_%s.pdf",y_title), width = 5, height = 5)

  row_names_to_remove <- as.numeric(names(cooksd)[(cooksd > 15*mean(cooksd, na.rm=T))])
  outlier_list <- c(outlier_list,row_names_to_remove)

}
outlier_list <- unique(outlier_list)
```

## technical outliers
```{r}
## Treg data is missing in  sample identifiers: 46, 229, 256, 312. 62 & 171 poor sample quality 
outlier_list <- unique(c(outlier_list, c(46,229,256,312,62,171)))

## Remove outliers from the working dataset
vital.truc_influ_d0_immvar_sel <- vital.truc_influ_d0_immvar_sel[!(row.names(vital.truc_influ_d0_immvar_sel) %in% outlier_list),]

## Remove outliers from the raw dataset
vital.truc_influ_d0_ro <- vital.truc_influ_d0[!(row.names(vital.truc_influ_d0) %in% outlier_list),]
```

# Data organization and scaling
```{r}
## add chronic viral infection (CVI) data to the subject identifiers
vital.influ_d0_CVI <- vital.truc_influ_d0_ro %>% 
  select(subject_identifier, sex, age, age_group, timepoint, timepoint_days) %>% 
  left_join(chronic_viral_inf,by="subject_identifier") %>%
  mutate_at(c("sex","age_group","timepoint","timepoint_days","MIA_CMV_Seropositivity","MIA_EBV_Seropositivity","MIA_VZV_Seropositivity","CMV_EBV_combined"),list(~factor(.))) 

## add CVI to trucount
vital.truc_influ_d0_CVI <- vital.truc_influ_d0_ro %>% 
  select(-c(sex, age, age_group, timepoint, timepoint_days)) %>% 
  left_join(vital.influ_d0_CVI, by="subject_identifier")


vital.truc_influ_d0_immvar_sel_scl <- as.data.frame(scale(vital.truc_influ_d0_immvar_sel, center=TRUE, scale=TRUE))
head(vital.truc_influ_d0_immvar_sel_scl)

## Select the dataset that will be used for PCA & Cluster analysis
dat <- vital.truc_influ_d0_immvar_sel_scl
```

# Table 1, cohort characteristics
```{r}
## data organization
tabledata <- vital.truc_influ_d0 %>% left_join(chronic_viral_inf, by="subject_identifier") %>%
  filter(subject_identifier %!in% c("46","229","256","312","62","171")) %>% #Remove technical outliers
  select(age,age_group,sex,MIA_CMV_Seropositivity,MIA_EBV_Seropositivity,MIA_VZV_Seropositivity,subject_identifier) %>% 
  left_join(beckman_coulter_d0, by="subject_identifier") %>% #Add cell coulter data
  select(-c(subject_identifier,RBC,HGB,HCT,MCV,MCH,MCHC,RDW,RDWSD,MPV,PLT)) %>% 
  mutate(sex = recode(sex, "1" = "Male", "2" = "Female"), #rename variables
         age_group = recode(age_group, "25-49" = "Age 25-49", "50-64"="Age 50-64", "65-98"="Age 65-98"),
         MIA_CMV_Seropositivity = recode(MIA_CMV_Seropositivity, "1" = "+", "2" = "-", "3" = "borderline"),
         MIA_EBV_Seropositivity = recode(MIA_EBV_Seropositivity, "1" = "+", "2" = "-", "3" = "borderline"),
         MIA_VZV_Seropositivity = recode(MIA_VZV_Seropositivity, "1" = "+", "2" = "-"))

## create the table
table1 <- tbl_summary(tabledata,
    by = age_group, 
    missing = "no",
    type = all_continuous() ~ "continuous2",
    statistic = list(all_continuous() ~  c("{median}" ,"{min}, {max}"))) %>%
  add_n() %>% 
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels() 
table1

# save table 
gt_table <- table1 %>% 
  gtsummary::as_tibble()

# export to excel 
writexl::write_xlsx(gt_table, paste0(analysis.path, "/results/tables/table_1.xlsx", sep=""))
```

## statistical analysis for the immune subsets (Table1)
```{r}
## select the dataset
df_stat <- tabledata[,-1]

## subject identifier and cluster number as.character
df_stat %<>% mutate_at(
  c("age_group"),
  list(~as.character(.)))

## melt
df_stat_melt <- df_stat %>% 
  reshape2::melt(.)
df_stat_melt

### kruskal.test and Dunn's test
## With kruskal.test we identify overall which subsets are significant and then Dunn's test tells us which are different between pairs of clusters
kw.test.all <- df_stat_melt %>% 
  group_by(variable) %>% 
  kruskal_test(value ~ age_group) %>% 
  adjust_pvalue(method = "BH") #BH correction

kw.test.all.eff.size <- df_stat_melt %>% #effect size
  group_by(variable) %>% 
  kruskal_effsize(value ~ age_group) 

combine.kw <- kw.test.all %>% 
  left_join(kw.test.all.eff.size, by="variable")

## Number of variables with p.adj-value <0.05
length(combine.kw$variable)

## table summarizing effect size of the significant variables 
table(combine.kw$magnitude)

### Post-hoc analysis dunn's test, pairwise multiple comparisons to check which are significant in pairwise analysis.
dun.test.pos <- df_stat_melt %>% 
  group_by(variable) %>% 
  dunn_test(value ~ age_group, p.adjust.method = "BH", detailed = TRUE)

head(dun.test.pos)
dun.test.pos_sub <- dun.test.pos %>% filter(p.adj<=0.05) #filter non significant data

unique(dun.test.pos$variable)

## save excel sheet
writexl::write_xlsx(dun.test.pos_sub, paste0(analysis.path, "/results/tables/dun.test.pos_table.xlsx", sep=""))

```

## statistical analysis for the CMV, EBV, VZV, Sex (Table1)
```{r}
## CMV
tabledata_stat <- tabledata %>% 
  filter(MIA_CMV_Seropositivity %in% c("+",'-')) %>% #remove borderline cases & people without CMV data
  droplevels()
table(tabledata_stat$age_group,tabledata_stat$MIA_CMV_Seropositivity)
chisq.test(tabledata_stat$age_group,tabledata_stat$MIA_CMV_Seropositivity)

## EBV
tabledata_stat <- tabledata %>% 
  filter(MIA_EBV_Seropositivity %in% c("+",'-')) %>% #remove people without EBV data
  droplevels()
table(tabledata_stat$age_group,tabledata_stat$MIA_EBV_Seropositivity)
chisq.test(tabledata_stat$age_group,tabledata_stat$MIA_EBV_Seropositivity)

## VZV
table(tabledata$age_group,tabledata$MIA_VZV_Seropositivity)
chisq.test(tabledata$age_group,tabledata$MIA_VZV_Seropositivity)

## Sex
table(tabledata$age_group,tabledata$sex)
chisq.test(tabledata$age_group,tabledata$sex) ##result is significant, proceed with Dunn's test

#### Find the significant pairwise comparison for sex differences in age groups
tabledata %>% 
  dunn_test(sex ~ age_group, p.adjust.method = "BH", detailed = TRUE)

```

# Baseline differences, age ~ immune subset correlations
## create output directory
```{r}
## create output directory
dir.create(file.path(analysis.path, "results/figures/baseline_differences"), showWarnings = FALSE)
baseline_differences_save.dir <- paste0(analysis.path, "/results/figures/baseline_differences/", sep="")
```

## subsetting markers for correlation
```{r}
## markers to be correlated
Dat_corr <-   vital.truc_influ_d0 %>% 
  filter(subject_identifier %!in% c(46,229,256,312,62,171)) %>% #remove technical outliers
  select(-c(fcs_file,subject_identifier,sample_identifier,age_group,timepoint,timepoint_days,sex)) #remove non-immune data columns
```

## calculate correlation and create the correlation matrix
```{r}
## generate spearman cor matrix
Dat_corr_matrix <- cor(Dat_corr, method = "spearman", use = "complete.obs") # complete.obs when missing values are present
head(Dat_corr_matrix[, 1:4]) # quick look at the matrix

## calculate p values
p.mat <- cor.mtest(Dat_corr_matrix,conf.level = 0.95) #set confidence level

## Rho, I select the age column only, since I am interested in age ~ subset correlation
Dat_corr_matrix <- as.data.frame(Dat_corr_matrix) %>% 
  select(age) 
colnames(Dat_corr_matrix) <- "rho" ##rename the rho

## pvalues, I select the age column only
p.mat <- as.data.frame(p.mat) %>% select(age) 
colnames(p.mat) <- "p_value"##rename p_value

## binding rho & pvalues
Dat_corr_matrix <- cbind(Dat_corr_matrix,p.mat) 

## Applying FDR correction
Dat_corr_matrix$adj_p_value <- p.adjust(p=Dat_corr_matrix$p_value, method="bonferroni", n=length(Dat_corr_matrix$p_value))

Dat_corr <- Dat_corr_matrix[-1,] # Removing age row
Dat_corr$imm_subset <- rownames(Dat_corr) #rownames as a column

head(Dat_corr)

## save the results as a table, Supplementary figure 2
write_xlsx(Dat_corr,"age_immsubset_correlations.xlsx")

```

## Figure 2A-B, plot the correlation scores and p values, all subsets in one figure
```{r}
## plot x axis ordered by rho, plotting rho on y axis
m <-Dat_corr %>%
  mutate(name = fct_reorder(imm_subset, rho)) %>%
  ggplot(aes(x=name, y=rho, color=rho)) +
  geom_point(shape=2)+
  scale_colour_gradient2(
    low = "red", 
    mid = "grey",
    high = "blue", 
    midpoint = 0, 
    guide = "colourbar")+
  theme_classic()+
  theme(legend.position="none",
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  geom_hline(yintercept=0.2, linetype="dashed", 
             color = "darkgrey", size=0.8)+
  geom_hline(yintercept=-0.2, linetype="dashed", 
             color = "darkgrey", size=0.8)
m

## plot x axis ordered by rho, plotting adjusted p values on y axis
n <-Dat_corr %>%
  mutate(name = fct_reorder(imm_subset, rho)) %>%
  ggplot(aes(x=name, y=-log10(adj_p_value), color=rho)) +
  geom_point(shape=6) +  
  scale_colour_gradient2(
    low = "red", 
    mid = "grey",
    high = "blue", 
    midpoint = 0, 
    guide = "colourbar")+ 
  theme_classic() +
  theme(legend.position="bottom",
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  geom_hline(yintercept=3, linetype="dashed", 
                color = "darkgrey", size=0.8)
n

## arrange the figures in a plot
ggarrange_1 <- egg::ggarrange(m,n,ncol=1) 

## save figures
pdf(file = paste0(baseline_differences_save.dir, "subsets_spearman_rho.pdf", sep=""), width =12 , height =5) ; ggarrange_1 ; dev.off() #save as a pdf
```

## apply rho & p-value tresholds
```{r}
## filter based on rho & p value 
## for absolute number data
Dat_corr %>% filter(adj_p_value<0.001) %>% 
  filter(-0.2>rho | rho>0.2) %>% 
  dplyr::filter(!grepl("_num",imm_subset))

## for percentage data
Dat_corr %>% filter(adj_p_value<0.001) %>% 
  filter(-0.2>rho | rho>0.2) %>%
  dplyr::filter(!grepl("_per",imm_subset))
```

## correlation plots for each subset separately, Figure 2D-K, Supplementary Figure 2A-B
### correlation with age
```{r}
## immune subsets to use
y_title2 <- c("monocytes_num",
              "granulocytes_num",
              "lymphocytes_per",
              "CD8_TrueNaive_per",
              "CD4_TrueNaive_per",
              "CD4_Treg_per",
              "CD56dim_num",
              "CD8_CD95+_per",
              "CD3-_per",
              "CD8_TrueNaive_num",
              "CD4_TrueNaive_num",
              "CD19+_per",
              "CD56dim_HLADR+_per",
              "CD4_HLADR+_per",
              "CD8_HLADR+_per",
              "CD4_Treg_HLADR+_per"
              )

## generate plots, r values for the whole cohort 
for (i in y_title2){
  plotx <- ggscatter(vital.truc_influ_d0_ro, 
                     x = "age", 
                     y = i,
                     alpha = 0.5,
                     xlab = "Age",
                     palette = c("#e3d94d", "#85C0F9", "#F5793A"),
                     color = "age_group",
                     add = "loess",  # Add regression line
                     add.params = list(color = "black", fill = "lightgray"), # Customize reg. line
                     conf.int = TRUE)+ # Add confidence interval
    xlim(22,100)+
    stat_cor(show.legend = FALSE,
             method = "spearman",
             p.accuracy = 0.001,
             r.accuracy = 0.01)+
    theme(legend.position = "none")
  assign(paste0("plot_", i), plotx)
}

## Supplementary Figure 2, plots
ggarrange_3 <- egg::ggarrange(plot_monocytes_num,
                              plot_granulocytes_num,
                              plot_lymphocytes_per,
                              `plot_CD19+_per`,
                              plot_CD8_TrueNaive_num,
                              plot_CD4_TrueNaive_num,
                              plot_CD4_Treg_per,
                              `plot_CD56dim_num`,
                              plot_CD8_TrueNaive_per,
                              plot_CD4_TrueNaive_per,
                              `plot_CD8_CD95+_per`,
                               `plot_CD3-_per`,
                               `plot_CD4_HLADR+_per`,
                              `plot_CD8_HLADR+_per`,
                               `plot_CD4_Treg_HLADR+_per`,
                              `plot_CD56dim_HLADR+_per`
                               ,ncol=4)

## save the plot
pdf(file = paste0(baseline_differences_save.dir, "Scatterplot_grid_r_age.pdf", sep=""), width =15 , height =15) ; ggarrange_3 ; dev.off()


## generate plots, r values for age groups
for (i in y_title2){
  plotx <- ggscatter(vital.truc_influ_d0_ro, 
                     x = "age", 
                     y = i,
                     alpha = 0.5,
                     xlab = "Age",
                     palette = c("#e3d94d", "#85C0F9", "#F5793A"),
                     color = "age_group",
                     add = "loess",  # Add regression line
                     add.params = list(color = "black", fill = "lightgray"), # Customize reg. line
                     conf.int = TRUE)+ # Add confidence interval
    xlim(22,100)+
    stat_cor(aes(color = age_group),
             show.legend = FALSE,
             method = "spearman",
             p.accuracy = 0.001,
             r.accuracy = 0.01)+
    theme(legend.position = "none")
  assign(paste0("plot_", i), plotx)
}

## Arrange the plots
ggarrange_3 <- egg::ggarrange(plot_monocytes_num,
                              plot_granulocytes_num,
                              plot_lymphocytes_per,
                              `plot_CD19+_per`,
                              plot_CD8_TrueNaive_num,
                              plot_CD4_TrueNaive_num,
                              plot_CD4_Treg_per,
                              `plot_CD56dim_num`,
                              plot_CD8_TrueNaive_per,
                              plot_CD4_TrueNaive_per,
                              `plot_CD8_CD95+_per`,
                               `plot_CD3-_per`,
                               `plot_CD4_HLADR+_per`,
                              `plot_CD8_HLADR+_per`,
                               `plot_CD4_Treg_HLADR+_per`,
                              `plot_CD56dim_HLADR+_per`
                               ,ncol=4)

## save the plot
pdf(file = paste0(baseline_differences_save.dir, "Scatterplot_grid_r_age_group.pdf", sep=""), width =15 , height =15) ; ggarrange_3 ; dev.off()
```




# Baseline differences, coefficient of variation comparison between percentages vs absolute numbers Figure 2B-C
```{r}
## subset absolute number data
data_CV_num <- vital.truc_influ_d0 %>% 
  filter(subject_identifier %!in% c(46,229,256,312,62,171)) %>% #remove technical outliers
  select(-c(fcs_file,subject_identifier,sample_identifier,age_group,timepoint,timepoint_days,sex,age)) %>%
  dplyr::select(dplyr::contains("_num"))

## subset percentage data
data_CV_per <- vital.truc_influ_d0 %>% 
  filter(subject_identifier %!in% c(46,229,256,312,62,171)) %>% #remove technical outliers
  select(-c(fcs_file,subject_identifier,sample_identifier,age_group,timepoint,timepoint_days,sex,age)) %>%
  dplyr::select(dplyr::contains("_per"))

## calculate coefficient of variation for absolute numbers
colMeans(data_CV_num)
sds_vals_data_p <- apply(data_CV_num, 2, sd)
colmean_val_data_p <- colMeans(data_CV_num)
data_CV_num <- as.data.frame(sds_vals_data_p/colmean_val_data_p)

data_CV_num$data_type <- "num"
data_CV_num$subset <- rownames(data_CV_num)
rownames(data_CV_num) <- c()
data_CV_num$subset <- gsub("_num", "", data_CV_num$subset)


## calculate coefficient of variation for cell percentages
colMeans(data_CV_per)
sds_vals_data_p <- apply(data_CV_per, 2, sd)
colmean_val_data_p <- colMeans(data_CV_per)
data_CV_per <- as.data.frame(sds_vals_data_p/colmean_val_data_p)

data_CV_per$data_type <- "per"
data_CV_per$subset <- rownames(data_CV_per)
rownames(data_CV_per) <- c()
data_CV_per$subset <- gsub("_per", "", data_CV_per$subset)

## merge coefficient of variation scores for absolute numbers and percentages
data_CV <- data_CV_per %>% full_join(data_CV_num)
colnames(data_CV)[1] <- "CV"

data_CV$data_type <- factor(data_CV$data_type,
  levels = c("num", "per"))

## paired wilcox test for the coefficient of variation scores between absolute numbers and percentages
test_CV <- wilcox.test(data_CV$CV ~ data_CV$data_type,
  paired = TRUE
)
test_CV

## generate paired box plot with wilcox test
s1 <- ggpaired(data_CV, x = "data_type", y = "CV",
               color = "data_type", 
               line.color = "gray",
               line.size = 0.01,
               palette = "jco")+ 
  xlab("") +
  ylab("Coefficient of variation")+
  stat_compare_means(paired = TRUE)
## save plot
pdf(file = paste0(baseline_differences_save.dir, "Immune_cell_subset_per_vs_num_CV_boxplot.pdf", sep=""), width =3 , height =3.5) ; s1 ; dev.off()
s1

## generate plot showing coefficient of variation of each subset (percentages and absolute numbers)
s2 <- ggplot(data_CV, aes(subset, CV)) +
  geom_linerange(
    aes(x= reorder(subset, -CV), ymin = 0, ymax = CV, group = data_type),
    color = "lightgray", size = 0.1)+
  geom_point(
    aes(color = data_type),
    position = position_dodge(0), size = 2, alpha=0.4)+
  scale_color_manual(values = c("#0073C2FF", "#EFC000FF"))+
  theme_classic()+
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  xlab("immune cell subsets")+
  ylab("Coefficient of variation")
## save plot
pdf(file = paste0(baseline_differences_save.dir, "Immune_cell_subset_per_vs_num_CV_line.pdf", sep=""), width =9 , height =3.5) ; s2 ; dev.off()

## merge the figures before saving
ggarrange_4 <- egg::ggarrange(s2,
                              s1,
                              widths = c(3.5,1),
                              ncol=2)
## save plot
pdf(file = paste0(baseline_differences_save.dir, "Immune_cell_subset_per_vs_num_CV_line_box.pdf", sep=""), width =12 , height =4) ; ggarrange_4 ; dev.off()
```

# Baseline, most variable immune subset with age, linear regression model age+sex+CMV
```{r}
## subset CMV seropositivity data
CMV_sub <- chronic_viral_inf %>% 
  select(subject_identifier, MIA_CMV_Seropositivity) 

## subset immune subset data
vital_d0_truc_ro_sub <- vital.truc_influ_d0_ro %>%
  select(-c(fcs_file,sample_identifier,age_group, timepoint,timepoint_days))

## merge immune subset and cmv data, filter out borderline cmv cases
vital_d0_truc_CMV_ro <- CMV_sub %>%
  left_join(vital_d0_truc_ro_sub, by="subject_identifier") %>%
  drop_na() %>%
  relocate(where(is.numeric), .after = last_col()) %>%
  filter(MIA_CMV_Seropositivity %in% c(1,2)) %>%
  droplevels()

## save the names of the immune variables for the model
var_model <- colnames(vital_d0_truc_CMV_ro)[c(5:ncol(vital_d0_truc_CMV_ro))] 

## start with an empty dataframe
cor_res <- c() %>% as.data.frame() 

## for loop to calculate regression between each immune variable & age+sex+CMV
## later it calculates correlation between residuals of these models and age, then saves it in a dataframe cor_res
for (i in var_model) {
  Variable_md <- vital_d0_truc_CMV_ro[[i]] 
  Variable_df <- vital_d0_truc_CMV_ro[[i]] %>% 
    as.data.frame() %>%
    setNames(., c(print(i))) 
  
  mod_set <- lm( Variable_md ~
                   age+
                   sex+
                   MIA_CMV_Seropositivity,
                 data = vital_d0_truc_CMV_ro)
  
  cor_df <- cbind(as.data.frame(vital_d0_truc_CMV_ro$age),as.data.frame(mod_set$residuals))
  par <- cor_test(cor_df,method = "spearman")
  par$var2 <- i
  cor_res <- rbind(cor_res,par)
}

##  correct for multiple testing and filter out non-significant entries
cor_res1 <- cor_res %>%
  adjust_pvalue(method = "BH") %>%
  filter(p.adj<0.05) %>%
  arrange(desc(cor))
cor_res1

## top 5 highest correlations
cor_res1_top <- cor_res1 %>% arrange(desc(cor)) %>% slice(1:5)

## top 5 lowest correlations
cor_res1_bottom <- cor_res1 %>% arrange(-desc(cor)) %>% slice(1:5)

## bind top 5 highest and lowest correlations
cor_res1_topbottom <- rbind(cor_res1_top,cor_res1_bottom)

## save in table, Supplementary table 1
write_xlsx(cor_res1_topbottom,"cor_res2_topbottom.xlsx")
```





# Baseline immune subset differences (log2 mean) between Sex, CMV, EBV, Supplementary Figure 3 A-C (bar plots)
## sex differences
```{r}
## subset sex differences
influ_summ_sex_fc <- vital.truc_influ_d0_ro %>% 
  select(-c(fcs_file,sample_identifier,subject_identifier,age,age_group,timepoint,timepoint_days)) %>% 
  group_by(sex) %>% 
  summarise_all(list(mean)) %>% 
  select(-c(sex)) %>% 
  select(colnames(vital.truc_influ_d0_immvar_sel))

## calculate log2 fc
influ_sex_log2_fc <- log2(influ_summ_sex_fc[1,] /influ_summ_sex_fc[2,])

## organize the data
vital.truc_influ_d0_sex_log2_fc_melt <- influ_sex_log2_fc %>% 
  reshape2::melt(.) %>% 
  mutate_at(c("variable"), list(~as.character(.)))
```

## CMV infection differences
```{r}
## subset CMV differences
vital.truc_influ_d0_CMV <- vital.influ_d0_CVI %>% select(-c(MIA_EBV_Seropositivity,CMV_EBV_combined,sex,age,age_group,timepoint,timepoint_days,MIA_CMV_Titer,MIA_EBV_Titer,MIA_VZV_Titer,MIA_VZV_Seropositivity)) %>%
  left_join(vital.truc_influ_d0, by="subject_identifier") %>% 
  select(-c(sex,age,age_group,timepoint,timepoint_days,fcs_file,subject_identifier,sample_identifier)) %>%
  group_by(MIA_CMV_Seropositivity) %>%
  summarise_all(list(mean)) %>%
  filter(MIA_CMV_Seropositivity %in% c("1","2")) %>% ## subset data, remove "borderline" cases
  select(-c(MIA_CMV_Seropositivity)) %>%
  select(colnames(vital.truc_influ_d0_immvar_sel))

## calculate log2 fc 
vital.truc_influ_d0_CMV_log2_fc <- log2(vital.truc_influ_d0_CMV[1,] /vital.truc_influ_d0_CMV[2,])

## organize the data
vital.truc_influ_d0_CMV_log2_fc_melt <- vital.truc_influ_d0_CMV_log2_fc %>% 
  reshape2::melt(.) %>% 
  mutate_at(c("variable"), list(~as.character(.)))
```

## EBV infection differences (in CMV-)
```{r}
## subset CMV-EBV+ vs CMV-EBV-
vital.truc_influ_d0_CMVnEBVp_CMVnEBVn <- vital.influ_d0_CVI %>% select(-c(MIA_EBV_Seropositivity,MIA_CMV_Seropositivity,sex,age,age_group,timepoint,timepoint_days,MIA_CMV_Titer,MIA_EBV_Titer,MIA_VZV_Titer,MIA_VZV_Seropositivity)) %>%
  left_join(vital.truc_influ_d0, by="subject_identifier") %>%
  select(-c(sex,age,age_group,timepoint,timepoint_days,fcs_file,subject_identifier,sample_identifier)) %>%
  filter(CMV_EBV_combined %in% c("CMV-EBV+","CMV-EBV-")) %>%
  group_by(CMV_EBV_combined) %>%
  summarise_all(list(mean)) %>%
  select(-c(CMV_EBV_combined)) %>%
  select(colnames(vital.truc_influ_d0_immvar_sel))

## calculate log2 fc 
vital.truc_influ_d0_CMVnEBVp_CMVnEBVn_log2_fc <- log2(vital.truc_influ_d0_CMVnEBVp_CMVnEBVn[2,] /vital.truc_influ_d0_CMVnEBVp_CMVnEBVn[1,])

## organize the data
vital.truc_influ_d0_CMVnEBVp_CMVnEBVn_log2_fc_melt <- vital.truc_influ_d0_CMVnEBVp_CMVnEBVn_log2_fc %>% 
  reshape2::melt(.) %>%
  mutate_at(c("variable"), list(~as.character(.)))
```

## plot & save log2 mean immune subset differences between sex, cmv, ebv
```{r}
## Sex
plot_sex <- vital.truc_influ_d0_sex_log2_fc_melt %>% 
  ggplot(aes(x=reorder(variable,value),y= value)) + 
  geom_bar(stat="identity") +
  theme_classic()+
  theme(axis.text.x=element_text(angle = -90, hjust = 0)) +
  labs(title="mean log2 fc male/female",y="mean log2 fc",x = "")
pdf(file = paste0(baseline_differences_save.dir, "mean_log2fc_sex.pdf", sep=""), width =5 , height =8) ; plot_sex ; dev.off()

## CMV
plot_cmv <- vital.truc_influ_d0_CMV_log2_fc_melt %>% 
  ggplot(aes(x=reorder(variable,value),y= value)) + 
  geom_bar(stat="identity") + 
  theme_classic() +
  theme(axis.text.x=element_text(angle = -90, hjust = 0)) +
  labs(title="mean log2 fc CMV+/CMV-",y="mean log2 fc",x = "")
pdf(file = paste0(baseline_differences_save.dir, "mean_log2fc_CMV.pdf", sep=""), width =5 , height =8) ; plot_cmv ; dev.off()

## CMV-EBV+ vs CMV-EBV-
plot_cmvebv <- vital.truc_influ_d0_CMVnEBVp_CMVnEBVn_log2_fc_melt %>% 
  ggplot(aes(x=reorder(variable,value),y= value)) + 
  geom_bar(stat="identity") + 
  theme_classic() +
  theme(axis.text.x=element_text(angle = -90, hjust = 0)) +
  labs(title="mean log2 fc CMV-EBV+/CMV-EBV-",y="mean log2 fc",x = "")
pdf(file = paste0(baseline_differences_save.dir, "mean_log2fc_CMV-EBV+_CMV-EBV-.pdf", sep=""), width =5 , height =8) ; plot_cmvebv ; dev.off()
```

## align and save plots (log2fc conditions)
```{r}
ggarrange_x <- egg::ggarrange(plot_sex, 
                              plot_cmv, 
                              plot_cmvebv, ncol = 1)
## save plot
pdf(file = paste0(baseline_differences_save.dir, "subset_conds_log2fc.pdf", sep=""),width = 5 , height = 12); ggarrange_x; dev.off()
```

# Baseline differences in CMV infection & True naive T cell linear models
```{r}
## subset data
dat_CMV_lm <- vital.truc_influ_d0 %>% 
  left_join(chronic_viral_inf, by="subject_identifier") %>% 
  filter(MIA_CMV_Seropositivity %in% c("1","2")) %>%  #remove "borderline" cases
  mutate(MIA_CMV_Seropositivity = recode(MIA_CMV_Seropositivity, "1" = "(+)", "2" = "(-)"))

## lm CD4 True naive
fit1 <- lm(`CD4_TrueNaive_per` ~ MIA_CMV_Seropositivity+age+sex
          ,dat_CMV_lm)
summary(fit1)

## lm CD8 True naive
fit2 <- lm(`CD8_TrueNaive_per` ~ MIA_CMV_Seropositivity+age+sex
          ,dat_CMV_lm)
summary(fit2)

## plot models
plot_model(fit1, type = "pred", terms = c("age", "MIA_CMV_Seropositivity"))
plot_model(fit2, type = "pred", terms = c("age", "MIA_CMV_Seropositivity"))
```

# Principcal component analysis
## create output folder
```{r}
## create output folder
dir.create(file.path(analysis.path, "results/figures/PCA"),showWarnings = FALSE)
PCA_save.dir <- file.path(analysis.path, "results/figures/PCA/")
```

## calculate PCA
```{r}
## run PCA
res.pca <- PCA(dat, graph = FALSE) #dat is scaled

## extract eigen values
eig.val <- get_eigenvalue(res.pca) 

## Screeplot visualise eigen values
PCA_screeplot <- fviz_eig(res.pca, addlabels = TRUE, ylim = c(0, 25)) 
pdf(file = paste0(PCA_save.dir, "PCA_screeplot.pdf", sep=""), width =6 , height =5) ; PCA_screeplot ; dev.off()

## Extract the results for individuals only
var <- get_pca_var(res.pca)
# head(var$coord) #coordinates
# head(var$cos2) #Cos2: quality on the factore map
# head(var$contrib) #Contributions to the principal components

## Extract the results for variables only
ind <- get_pca_ind(res.pca)
# head(ind$coord) #coordinates
# head(ind$cos2) #Cos2: quality on the factore map
# head(ind$contrib) #Contributions to the principal components
```

## Generate PCA plots
```{r}
## PCA, generating plots 
## Visualization of PCA plot with geom density 
pca_geomdens <- fviz_pca_ind(res.pca,
                             geom.ind = "point", # show points only (but not "text")
                             legend.title = "PCA density") + 
  geom_density_2d()

## save
pdf(file = paste0(PCA_save.dir, "PCA_density.pdf", sep=""), width =5 , height =5) ; pca_geomdens ; dev.off()

## Visualization of top 10 parameters, contributions
PCA_variable_contribution_topx <- fviz_pca_var(res.pca, 
                                               col.var = "contrib",
                                               gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                                               repel=TRUE,
                                               title ="",
                                               select.var = list(name = NULL, cos2 = NULL, contrib = 10))
## save
pdf(file = paste0(PCA_save.dir, "PCA_variable_contribution_topx.pdf", sep=""), width =5 , height =5) ; PCA_variable_contribution_topx ; dev.off()

## Visualization of top 10 parameters,  cos2
PCA_variable_cos2_topx <- fviz_pca_var(res.pca, 
                                       col.var = "cos2",
                                       gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                                       repel=TRUE,
                                       title ="",
                                       select.var = list(name = NULL, cos2 = 10, contrib = NULL))
## save
pdf(file = paste0(PCA_save.dir, "PCA_variable_cos2_topx.pdf", sep=""), width =5 , height =5) ; PCA_variable_cos2_topx ; dev.off()

## Visualization of contributions all
PCA_variable_contribution <- fviz_pca_var(res.pca, 
                                          col.var = "contrib",
                                          gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                                          repel=TRUE,
                                          title ="contributions to PCs")
## save
pdf(file = paste0(PCA_save.dir, "PCA_variable_contribution.pdf", sep=""), width =10 , height =10) ; PCA_variable_contribution ; dev.off()


## Visualization of cos2 all
PCA_variable_cos2 <- fviz_pca_var(res.pca, 
                                  col.var = "cos2",
                                  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                                  repel=TRUE,
                                  alpha.var = "cos2",
                                  title ="cos2 to PCs")
## save
pdf(file = paste0(PCA_save.dir, "PCA_variable_cos2.pdf", sep=""), width =10 , height =10) ; PCA_variable_cos2 ; dev.off()

## PCA with age gradient, 3color
pca_age_gradient_3color <- fviz_pca_ind(res.pca,
             geom.ind = "point", # show points only (but not "text")
             col.ind = vital.truc_influ_d0_ro$age, # color by Age
             gradient.cols = c("red","#d5ddde","blue"), # gradient colors
             title ="Age gradient" ,
             legend.title = "Age",
             shape.ind= vital.truc_influ_d0_ro$age,
             pointsize = 0.9,
             alpha.ind = 1
             )
pca_age_gradient_3color 

## save
pdf(file = paste0(PCA_save.dir, "PCA_age_gradient_3color.pdf", sep=""), width =5 , height =5) ; pca_age_gradient_3color ; dev.off()

## PCA with age group
pca_agegroup_ell <- fviz_pca_ind(res.pca,
             geom.ind = "point", # show points only (but not "text")
             habillage = as.factor(vital.truc_influ_d0_ro$age_group),
             palette = c("#F0E442", "#85C0F9","#F5793A"),
             title ="Age groups" ,
             legend.title = "Age groups",
             ellipse.type= c("convex"),
             addEllipses = TRUE,
             pointsize = 0.9,
             alpha.ind = 1
             )
pca_agegroup_ell 

## save
pdf(file = paste0(PCA_save.dir, "PCA_age_group_3color.pdf", sep=""), width =5 , height =5) ; pca_agegroup_ell ; dev.off()

## PCA with sex differences
pca_sex <- fviz_pca_ind(res.pca,
             geom.ind = "point", # show points only (but not "text")
             habillage = as.factor(vital.truc_influ_d0_ro$sex),
             palette = c("#E69F00","#56B4E9"),
             title ="Sex" ,
             ellipse.type= c("convex"),
             legend.title = "Sex",
             addEllipses = TRUE,
             pointsize = 0.9,
             alpha.ind = 1
             )
pca_sex 

## save
pdf(file = paste0(PCA_save.dir, "PCA_sex.pdf", sep=""), width =5 , height =5) ; pca_sex ; dev.off()

## PCA with CMV differences
pca_CMV <- fviz_pca_ind(res.pca,
             geom.ind = "point", # show points only (but not "text")
             habillage = as.factor(vital.influ_d0_CVI$MIA_CMV_Seropositivity),
             palette = c("#E69F00","#56B4E9","gray"),
             title ="CMV status" ,
             ellipse.type= c("convex"),
             legend.title = "CMV status",
             addEllipses = TRUE,
             pointsize = 0.9,
             alpha.ind = 1
             )
pca_CMV 

## save
pdf(file = paste0(PCA_save.dir, "PCA_CMV.pdf", sep=""), width =5.5 , height =5) ; pca_CMV ; dev.off()

pca_EBV <- fviz_pca_ind(res.pca,
             geom.ind = "point", # show points only (but not "text")
             habillage = as.factor(vital.influ_d0_CVI$MIA_EBV_Seropositivity),
             palette = c("#E69F00","#56B4E9","gray"),
             title ="EBV status" ,
             ellipse.type= c("convex"),
             legend.title = "EBV status",
             addEllipses = TRUE,
             pointsize = 0.9,
             alpha.ind = 1
             )
pca_EBV 

## save
pdf(file = paste0(PCA_save.dir, "PCA_EBV.pdf", sep=""), width =5.5 , height =5) ; pca_EBV ; dev.off()

pca_CMV_EBV <- fviz_pca_ind(res.pca,
             geom.ind = "point", # show points only (but not "text")
             habillage = as.factor(vital.influ_d0_CVI$CMV_EBV_combined),
             palette = c("grey","#009E73","#56B4E9","#F0E442","#D55E00"),
             title ="CMV/EBV status" ,
             ellipse.type= c("convex"),
             legend.title = "CMV/EBV status",
             addEllipses = TRUE,
             pointsize = 0.9,
             alpha.ind = 1
             )
pca_CMV_EBV 

## save
pdf(file = paste0(PCA_save.dir, "PCA_CMV_EBV_combined.pdf", sep=""), width =6 , height =5) ; pca_CMV_EBV ; dev.off()
```

## align and save plots (PCA age gradient and cos2) Figure 3A-B
```{r}
ggarrange_x <- egg::ggarrange(pca_age_gradient_3color,PCA_variable_cos2_topx, ncol = 2)
pdf(file = paste0(PCA_save.dir, "PCA_age_and_cos2.pdf", sep=""),width = 8 , height = 3.5); ggarrange_x; dev.off()
```

## align and save plots (PCA conditions) Supplementary Figure 3 A-C (PCA plots)
```{r}
ggarrange_x <- egg::ggarrange(pca_sex, 
                              pca_CMV, 
                              pca_CMV_EBV, ncol = 1)
pdf(file = paste0(PCA_save.dir, "PCA_conds.pdf", sep=""),width = 4.5 , height = 11); ggarrange_x; dev.off()
```

# Heatmap
## create output directory
```{r}
dir.create(file.path(analysis.path, "results/figures/heatmap"),showWarnings = FALSE)
heatmap_save.dir <- file.path(analysis.path, "results/figures/heatmap/")
```
## Generating annotation groups for Heatmap
```{r}
## define the dataset that will be used for heatmap, dat = the one used for PCA as well. 
dat_heatmap <- dat
head(dat_heatmap)

## ordering the heatmap data by age
dat_heatmap <-dat_heatmap[order(vital.truc_influ_d0_ro$age),]
head(dat_heatmap)
dim(dat_heatmap)

## Transposing the dat_heatmap
dat_heatmap <- as.data.frame(t(dat_heatmap))

## remove the outliers from annotation groups my_sample_col so my_sample_col will contain age and age group info of the the subject_IDs that are in dat_heatmap
vital.truc_influ_d0_ordered <-vital.truc_influ_d0_ro[order(vital.truc_influ_d0_ro$age),] #ordering the data by age 
my_sample_col <- vital.truc_influ_d0_ordered %>% select(age,age_group,sex,subject_identifier) #selecting subject_identifier, age, age_group, sex columns
my_sample_col <- my_sample_col[!(my_sample_col$subject_identifier %in% outlier_list),] #removing outliers
my_sample_col <- my_sample_col %>% select(-c(subject_identifier)) #remove subject_identifier

## check the dimensions of the datasets, should contain same number of rows
dim(my_sample_col)
dim(vital.truc_influ_d0_ro)
dim(t(dat_heatmap)) # was transposed, so check the row numbers in not-transposed 

## link age and age groups to my_sample_col
my_sample_col <- as.data.frame(my_sample_col)
row.names(my_sample_col) <- colnames(dat_heatmap)
head(my_sample_col)

## annotations for the Heatmap function
column_ha = HeatmapAnnotation(age = my_sample_col$age,
                              age_group=my_sample_col$age_group,
                              sex = my_sample_col$sex,
                              col = list(
                                age = circlize::colorRamp2(c(25, 92), c("grey92", "grey25")),
                                sex = c( `1` = "#DDCC77", `2`= "#117733"),
                                age_group = c(`25-49` = "#F0E442", `50-64` = "#85C0F9", `65-98` = "#F5793A" )))

## Heatmap function needs a matrix
mdat_heatmap <- as.matrix(dat_heatmap)

## calculating the distances
## rows
rd<-Dist(mdat_heatmap, method='correlation')
rc<-hclust(rd, method = "ward.D")
plot(rc)
## columns
cd<-Dist(t(mdat_heatmap), method='correlation')
cc<-hclust(cd, method = "ward.D")
plot(cc)
```

## generate heatmaps
```{r}
## clusters rows and columns
Heatmap(mdat_heatmap,
        cluster_rows = rc,
        cluster_columns = cc,
        top_annotation = column_ha,
        column_names_gp = gpar(fontsize = 6),
        row_names_gp = gpar(fontsize = 6))
dev.print(pdf, file = paste0(heatmap_save.dir, "Heatmap_VITAL_influ_d0_sel_cordist_rows_cols_rownames.pdf", sep=""), width = 12, height = 6.5)

## clusters rows 
Heatmap(mdat_heatmap,
        cluster_rows = rc,
        cluster_columns = FALSE,
        top_annotation = column_ha,
        column_names_gp = gpar(fontsize = 6),
        row_names_gp = gpar(fontsize = 6))
dev.print(pdf, file = paste0(heatmap_save.dir, "Heatmap_VITAL_influ_d0_sel_cordist_rows_rownames.pdf", sep=""), width = 12, height = 6)
```

# Clustering/Immunotypes
## create output directory
```{r}
dir.create(file.path(analysis.path, "results/figures/clustering_check"),showWarnings = FALSE)
clustering_save.dir <- paste0(analysis.path, "/results/figures/clustering_check/", sep="")
```

## spearman matrix calculation
```{r}
## calculating spearman matrix based on selected immune parameters 
spearman_matrix <- dat %>% 
  t() %>% #transposed so the donors will be correlated
  cor(method = "spearman")
```
## Gap statistics, optimum cluster number calculation
```{r}
## Gap statistics, testing the optimal number of clusters
set.seed(935934)
gap_stat_spearman <-fviz_nbclust(spearman_matrix,
                                 kmeans,
                                 method = "gap_stat",
                                 k.max=20,
                                 diss = as.dist(spearman_matrix),
                                 nboot = 50, nstart=25)
plot(gap_stat_spearman) 

## save
pdf(file = paste0(clustering_save.dir, "gap_stat_spearman_influ.pdf", sep=""), width =6 , height =3) ; plot(gap_stat_spearman) ; dev.off()
```

## cluster the data based on number of clusters identified by gap statistics
```{r}
## kmeans clustering, using 9 clusters obtained from gap statistics
set.seed(935934)
cluster_kmeans_spearmanmatrix <-kmeans(spearman_matrix, centers=9, nstart = 100)
```

## calculating silhouette scores for kmeans clustering with 9 clusters
```{r}
## calculating silhouette scores for kmeans clustering with 9 clusters
sil1 <- silhouette(cluster_kmeans_spearmanmatrix$cluster, 
                   dist(spearman_matrix))
fviz_silhouette(sil1)
dev.print(pdf, file = paste0(clustering_save.dir, "silhouette_kmeans_c9.pdf", sep=""), width = 5, height = 4)
```

## Visualise clusters on PCA (of spearman matrix)
```{r}
## Visualize clusters on PCA (of spearman matrix)
fviz_cluster(cluster_kmeans_spearmanmatrix,
             geom = c("point"), 
             ggtheme = theme_classic(),
             show.clust.cent=FALSE,
             ellipse=TRUE,
             ellipse.type= c("convex"),
             palette = cols_cluster,data = spearman_matrix)

dev.print(pdf, file =paste0(clustering_save.dir, "cluster_kmeans_spearmanmatrix_c9_point.pdf", sep="") , width = 9, height = 8)
```

## bind cluster/immunotype information to the working dataset
```{r}
## bind cluster information to the working dataset
clusters_nonordered <- cbind(cluster_number = cluster_kmeans_spearmanmatrix$cluster,vital.truc_influ_d0_ro) %>% 
  mutate_at(c("cluster_number"),list(~factor(.)))
```

## order clusters by median age
```{r}
## order clusters by median age
clusters_nonordered %>% group_by(cluster_number)  %>% summarise(median(age)) %>% arrange(`median(age)`) 

## reorder cluster numbers based on median age of the clusters, "done manually"
vital.truc_influ_d0_cluster <- clusters_nonordered %>% mutate(cluster_number = recode(cluster_number, 
                                                                                                "1" = "4",
                                                                                                "2" = "1",
                                                                                                "3" = "7",
                                                                                                "4" = "6",
                                                                                                "5" = "3",
                                                                                                "6" = "5",
                                                                                                "7" = "2",
                                                                                                "8" = "9",
                                                                                                "9" = "8" )) %>%
  mutate_at(c("sex","age_group","timepoint","timepoint_days","cluster_number"),list(~factor(.))) %>% 
  mutate_at(c("fcs_file","subject_identifier","sample_identifier"),list(~as.character(.))) %>%
  as.data.frame()

## reorder factors
vital.truc_influ_d0_cluster$cluster_number <- factor(vital.truc_influ_d0_cluster$cluster_number, 
                                                     levels = c("1","2","3","4","5","6","7","8","9"))

## check the age order of the clusters
vital.truc_influ_d0_cluster %>% 
  group_by(cluster_number) %>% 
  summarise(median(age)) %>% 
  arrange(`median(age)`) 
```

# Calculate the differences between immunotypes in baseline
## create output directory
```{r}
dir.create(file.path(analysis.path, "results/figures/cluster_differences"))
cluster_save.dir <- paste0(analysis.path, "/results/figures/cluster_differences/", sep="")
```

## CMV, VZV, EBV, sex abundances (as percentages) in immunotypes
```{r}
## merge cluster data & chronic viral infection data (without trucount information)
vital.truc_influ_d0_CVI_cluster <- vital.truc_influ_d0_cluster %>% 
  select(cluster_number, subject_identifier, sex, age, age_group, timepoint, timepoint_days) %>% 
  left_join(chronic_viral_inf,by="subject_identifier") %>%
  mutate_at(c("sex","age_group","timepoint","timepoint_days","cluster_number","MIA_CMV_Seropositivity","MIA_EBV_Seropositivity","MIA_VZV_Seropositivity","CMV_EBV_combined"),
            list(~factor(.))) 

## Sex differences in immunotypes
### in immunotypes
plot1 <- ggplot(vital.truc_influ_d0_cluster, aes(group = sex, y=1, x=cluster_number, fill=sex))+
  geom_bar(position="fill", stat="identity")+
  scale_fill_manual(values = c("#E69F00","#56B4E9"),name = "Sex status", labels = c("Male", "Female"))+
  xlab("Clusters")+
  ylab("Abundance")+
  theme_classic()

### in total
plot2 <- ggplot(vital.truc_influ_d0_cluster, aes(group = sex, y=1, x=timepoint, fill=sex))+
  geom_bar(position="fill", stat="identity")+
  scale_fill_manual(values = c("#E69F00","#56B4E9"),name = "Sex status", labels = c("Male", "Female"))+
  xlab("total")+
  ylab("")+
  theme_classic()+
  scale_y_continuous(labels = scales::percent)

plot_1 <- ggpubr::ggarrange(plot1, plot2,ncol = 2, nrow = 1,common.legend= TRUE,widths = c(3, 1))
plot_1

### save pdf
pdf(file = paste0(cluster_save.dir, "Abundances_Male_Female_in_clusters.pdf", sep=""), width =4 , height =3) ; plot_1 ; dev.off()

## CMV status ####
### in immunotypes
plot1 <- vital.truc_influ_d0_CVI_cluster %>% filter(MIA_CMV_Seropositivity != "3") %>%
  ggplot( aes(group = MIA_CMV_Seropositivity, y=1, x=cluster_number, fill=MIA_CMV_Seropositivity))+
  geom_bar(position="fill", stat="identity")+
  scale_fill_manual(values = c("#E69F00","#56B4E9"),name = "CMV status", labels = c("Positive", "Negative"))+
  xlab("Clusters") +
  ylab("Abundance")+
  theme_classic()+
  scale_y_continuous(labels = scales::percent)

### in total
plot2 <- vital.truc_influ_d0_CVI_cluster %>% filter(MIA_CMV_Seropositivity != "3") %>%
  ggplot( aes(group = MIA_CMV_Seropositivity, y=1, x=timepoint, fill=MIA_CMV_Seropositivity))+
  geom_bar(position="fill", stat="identity")+
  scale_fill_manual(values = c("#E69F00","#56B4E9"),name = "CMV status", labels = c("Positive", "Negative"))+
  xlab("total") +
  ylab("")+
  theme(axis.text.y = element_blank(),axis.ticks = element_blank())+
  theme_classic()+
  scale_y_continuous(labels = scales::percent)

plot_2 <- ggpubr::ggarrange(plot1, plot2,ncol = 2, nrow = 1,common.legend= TRUE,widths = c(3, 1))
plot_2

### save pdf
pdf(file = paste0(cluster_save.dir, "Abundances_CMV_clusters.pdf", sep="") , width =4 , height =3) ; plot_2 ; dev.off()

## EBV status ####
### in immunotypes
plot1 <- vital.truc_influ_d0_CVI_cluster %>% filter(MIA_EBV_Seropositivity != "3") %>%
  ggplot( aes(group = MIA_EBV_Seropositivity, y=1, x=cluster_number, fill=MIA_EBV_Seropositivity))+
  geom_bar(position="fill", stat="identity")+
  scale_fill_manual(values = c("#E69F00","#56B4E9"),name = "EBV status", labels = c("Positive", "Negative", "Borderline"))+
  xlab("Clusters") +
  ylab("Abundance")+
  theme_classic()+
  scale_y_continuous(labels = scales::percent)

### in total
plot2 <- vital.truc_influ_d0_CVI_cluster %>% filter(MIA_EBV_Seropositivity != "3") %>%
  ggplot( aes(group = MIA_EBV_Seropositivity, y=1, x=timepoint, fill=MIA_EBV_Seropositivity))+
  geom_bar(position="fill", stat="identity")+
  scale_fill_manual(values = c("#E69F00","#56B4E9"),name = "EBV status", labels = c("Positive", "Negative", "Borderline"))+
  xlab("total") +
  ylab("")+
  theme(axis.text.y = element_blank(),axis.ticks = element_blank())+
  theme_classic()+
  scale_y_continuous(labels = scales::percent)

plot_3 <- ggpubr::ggarrange(plot1, plot2,ncol = 2, nrow = 1,common.legend= TRUE,widths = c(3, 1))
plot_3

### save pdf
pdf(file = paste0(cluster_save.dir, "Abundances_EBV_clusters.pdf", sep=""), width =4 , height =3) ; plot_3 ; dev.off()

## VZV status ####
### in immunotypes
plot1 <- vital.truc_influ_d0_CVI_cluster %>% filter(MIA_VZV_Seropositivity != "3") %>%
  ggplot( aes(group = MIA_VZV_Seropositivity, y=1, x=cluster_number, fill=MIA_VZV_Seropositivity))+
  geom_bar(position="fill", stat="identity")+
  scale_fill_manual(values = c("#E69F00","#56B4E9"),name = "VZV status", labels = c("Positive", "Negative", "Borderline"))+
  xlab("Clusters") +
  ylab("Abundance")+
  theme_classic()+
  scale_y_continuous(labels = scales::percent)

### in total
plot2 <- vital.truc_influ_d0_CVI_cluster %>% filter(MIA_VZV_Seropositivity != "3") %>%
  ggplot( aes(group = MIA_VZV_Seropositivity, y=1, x=timepoint, fill=MIA_VZV_Seropositivity))+
  geom_bar(position="fill", stat="identity")+
  scale_fill_manual(values = c("#E69F00","#56B4E9"),name = "VZV status", labels = c("Positive", "Negative", "Borderline"))+
  xlab("total") +
  ylab("")+
  theme(axis.text.y = element_blank(),axis.ticks = element_blank())+
  theme_classic()+
  scale_y_continuous(labels = scales::percent)

plot_4 <- ggpubr::ggarrange(plot1, plot2,ncol = 2, nrow = 1,common.legend= TRUE,widths = c(3, 1))
plot_4

### save pdf
pdf(file =paste0(cluster_save.dir, "Abundances_VZV_clusters.pdf", sep=""), width =4 , height =3) ; plot_4 ; dev.off()

## CMV,EBV combined status ####
### in immunotypes
plot1 <- vital.truc_influ_d0_CVI_cluster %>% filter(CMV_EBV_combined != "Borderline") %>%
  ggplot( aes(group = CMV_EBV_combined, y=1, x=cluster_number, fill=CMV_EBV_combined))+
  geom_bar(position="fill", stat="identity")+
  scale_fill_manual(values = c("#009E73","#56B4E9","#F0E442","#D55E00"),name = "CMV & EBV status")+
  xlab("Clusters") +
  ylab("Abundance")+
  theme_classic()+
  scale_y_continuous(labels = scales::percent)

### in total
plot2 <- vital.truc_influ_d0_CVI_cluster %>% filter(CMV_EBV_combined != "Borderline") %>%
  ggplot( aes(group = CMV_EBV_combined, y=1, x=timepoint, fill=CMV_EBV_combined))+
  geom_bar(position="fill", stat="identity")+
  scale_fill_manual(values = c("#009E73","#56B4E9","#F0E442","#D55E00"),name = "CMV & EBV status")+
  xlab("total") +
  ylab("")+
  theme(axis.text.y = element_blank(),axis.ticks = element_blank())+
  theme_classic()+
  scale_y_continuous(labels = scales::percent)

plot_5 <- ggpubr::ggarrange(plot1, plot2,ncol = 2, nrow = 1,common.legend= TRUE,widths = c(3, 1))
plot_5

### save pdf
pdf(file = paste0(cluster_save.dir, "Abundances_CMV_EBV_combined_clusters.pdf", sep=""), width =4 , height =3) ; plot_5 ; dev.off()


## arrange and align plots sex, cmv, ebv 
ggarrange_2 <- egg::ggarrange(plot_1,plot_2,plot_3, ncol = 3)

### save pdf
pdf(file = paste0(cluster_save.dir, "Abundances_sex_CMV_EBV_ggarrange_clusters.pdf", sep=""), width =12 , height =3) ; ggarrange_2 ; dev.off()
```

## Heatmap - Immune subset differences in clusters Figure 4A
### summ
```{r}
## select immune variables used for clustering and cluster number, summarize the medians for those parameters
df_heatmap_cluster <- vital.truc_influ_d0_cluster %>% 
  select(c("cluster_number",colnames(vital.truc_influ_d0_immvar_sel))) %>% 
  group_by(cluster_number) %>% 
  summarise_all(list(median)) 

## now it is a tibble, convert to dataframe before setting the rownames as cluster numbers
df_heatmap_cluster <- as.data.frame(df_heatmap_cluster)
rownames(df_heatmap_cluster) <- df_heatmap_cluster$cluster_number

## remove the cluster number and transpose it for the heatmap
df_heatmap_cluster <- df_heatmap_cluster %>% 
  select(-c(cluster_number)) %>%
  t()

## color palette for the heatmap
h.col<-colorRampPalette(c("blue", "white", "red"))(31) 


## clusters and subsets based on correlation distance (row and column)
pheatmap(as.matrix(df_heatmap_cluster),
         cluster_rows = TRUE,# to have the dendrogram on the rows
         cluster_cols = TRUE, # to have the dendrogram on the columns
         show_rownames = TRUE,
         show_colnames =  TRUE,
         clustering_distance_rows = "correlation",
         clustering_distance_cols = "correlation",
         color = h.col,
         scale="row",
         main = "",
         border_color = NA)
dev.print(pdf, file = paste0(heatmap_save.dir, "pheatmap_VITAL_cluster_properties_row_col.pdf", sep=""), width = 6, height = 8)
```

### ggplot2 age in immunotypes to add to the heatmap Figure 4A
```{r}
## ggplot2 age in immunotypes to add to the heatmap
### ordering the levels as they appear in the heatmap

## generate plot
p <- ggplot(vital.truc_influ_d0_cluster, 
            aes(x=factor(cluster_number, level=c('8', '2', '9', '7','4','3','5','1','6') ), y=age )) +
  geom_boxplot(aes(fill=cluster_number), alpha=0.9,outlier.size=0,outlier.colour="white") +
  geom_jitter(aes(fill=cluster_number), alpha=0.4, width = 0.3, shape=21,size=1) +
  scale_fill_manual("immunotypes", values=cols_cluster) +
  theme_classic()+theme(legend.position="none")+ 
  coord_flip() +
  stat_summary(aes(y=age, x=cluster_number),size=0.2)+ 
  scale_y_continuous(limits = c(25, 100), breaks = seq(25, 100, by = 10))
p

## save pdf
dev.print(pdf, file = paste0(heatmap_save.dir, "cluster_age_heatmap_axis.pdf", sep=""), width = 3, height = 6)
```

## Boxplot - Immune subset differences in immunotypes
### create output folder
```{r}
## create output folder
dir.create(file.path(analysis.path, "results/figures/baseline_differences/age_group"),showWarnings = FALSE)
baseline_agegroup_save.dir <- file.path(analysis.path, "/results/figures/baseline_differences/age_group/")

dir.create(file.path(analysis.path, "results/figures/baseline_differences/cluster"),showWarnings = FALSE)
baseline_cluster_save.dir <- file.path(analysis.path, "/results/figures/baseline_differences/cluster/")
```

### boxplot age groups immune parameters
```{r}
### boxplot age groups ~ immune parameters
## saving figures
df_loop <- vital.truc_influ_d0_cluster
Xaxis <- df_loop$age_group
n <- ncol(df_loop)
Groups <- df_loop$age_group

## linear axis loop
for (i in c(5,10:n)){ #select the column data starts 
  Yaxis <- df_loop[[i]]
  y_title <- colnames(df_loop[i])
  p <- boxplot_agegroups()+labs(title="",x="Age group",y = y_title)
  pdf(file = paste0(baseline_agegroup_save.dir, paste("Baseline_agegroup_", y_title, "_linear.pdf", sep = ""), sep="") ,width = 3.5 , height = 3)
  print(p)
  dev.off()
}

# ## log axis loop
# for (i in c(5,11:n)){
#   Yaxis <- df_loop[[i]]
#   y_title <- colnames(df_loop[i])
#   p <- boxplot_agegroups_log()+labs(title="",x="Age group",y = y_title)
# 
#   pdf(file = paste0(baseline_agegroup_save.dir, paste("Baseline_agegroup_", y_title, "_log.pdf", sep = ""), sep="") ,width = 3.5 , height = 3)
#   print(p)
#   dev.off()
# }
```

### boxplot immunotypes immune parameters
```{r}
### boxplot immunotypes ~ immune parameters
## saving figures
df_loop <- vital.truc_influ_d0_cluster
Xaxis <- df_loop$cluster_number
n <- ncol(df_loop)
Groups <- df_loop$cluster_number

## linear axis loop
for (i in c(5,10:n)){ #select the column data starts 
  Yaxis <- df_loop[[i]]
  y_title <- colnames(df_loop[i])
  p <- boxplot_cluster()+labs(title="",x="Clusters",y = y_title)
  
  pdf(file = paste0(baseline_cluster_save.dir, paste("Baseline_cluster_", y_title, "_linear.pdf", sep = ""), sep="") ,width = 3.5 , height = 3)
  print(p)
  dev.off()
}

# ## log axis loop
# for (i in c(5,11:n)){ #select the column data starts
#   Yaxis <- df_loop[[i]]
#   y_title <- colnames(df_loop[i])
#   p <- boxplot_cluster_log()+labs(title="",x="Clusters",y = y_title)
# 
#   pdf(file = paste0(baseline_cluster_save.dir, paste("Baseline_cluster_", y_title, "_log.pdf", sep = ""), sep="") ,width = 3.5 , height = 3)
#   print(p)
#   dev.off()
# }
```

### additional immune cell subset ratios in immunotypes
```{r}
## Subsetting before calculating for Tscm/Truenaive
df_additional_subsets <- vital.truc_influ_d0_cluster %>% 
  select(subject_identifier,cluster_number,CD4_Tscm_num,CD4_TrueNaive_num,CD8_Tscm_num,CD8_TrueNaive_num)

## calculate the ratios
df_additional_subsets$`CD4_TscmTrueN` <- df_additional_subsets$CD4_Tscm_num / df_additional_subsets$CD4_TrueNaive_num
df_additional_subsets$`CD8_TscmTrueN` <- df_additional_subsets$CD8_Tscm_num / df_additional_subsets$CD8_TrueNaive_num

## remove the raw data
df_additional_subsets <- df_additional_subsets %>% 
  select(-c(CD4_Tscm_num,CD4_TrueNaive_num,CD8_Tscm_num,CD8_TrueNaive_num))

## saving figures
df_loop <- df_additional_subsets
Xaxis <- df_loop$cluster_number
n <- ncol(df_loop)
Groups <- df_loop$cluster_number

## lin axis loop
for (i in c(3:n)){ #select the column data starts 
  Yaxis <- df_loop[[i]]
  y_title <- colnames(df_loop[i])
  p <- boxplot_cluster()+labs(title="",x="Clusters",y = y_title)
  
  pdf(file = paste0(baseline_cluster_save.dir, paste("Baseline_cluster_", y_title, "_linear.pdf", sep = ""), sep="") ,width = 3.5 , height = 3)
  print(p)
  dev.off()
}

## log axis loop
for (i in c(3:n)){ #select the column data starts
  Yaxis <- df_loop[[i]]
  y_title <- colnames(df_loop[i])
  p <- boxplot_cluster_log()+labs(title="",x="Clusters",y = y_title)

  pdf(file = paste0(baseline_cluster_save.dir, paste("Baseline_cluster_", y_title, "_log.pdf", sep = ""), sep="") ,width = 3.5 , height = 3)
  print(p)
  dev.off()
}
```

##### ggarrange for figure, immune subsets in immunotypes Figure 4E-L
```{r}
df_loop <- vital.truc_influ_d0_cluster

## CD8_Teff_per
pc_1 <- ggplot(df_loop, aes(x=cluster_number, y=`CD8_Teff_per`)) +
  geom_boxplot(aes(fill=cluster_number),alpha=0.9,outlier.size=0,outlier.colour="white") +
  geom_jitter(aes(fill=cluster_number), alpha=0.4, width = 0.3, shape=21,size=1) +
  scale_fill_manual("Clusters", values=cols_cluster) +
  theme_classic()+
  theme(legend.position = "none")+
  stat_summary(aes(y=`CD8_Teff_per`, x=cluster_number),size=0.2)+
  labs(title="", x="", y="CD8 Teff (% of CD8)")
pc_1    

## CD8_TrueNaive_per
pc_2 <- ggplot(df_loop, aes(x=cluster_number, y=`CD8_TrueNaive_per`)) +
  geom_boxplot(aes(fill=cluster_number),alpha=0.9,outlier.size=0,outlier.colour="white") +
  geom_jitter(aes(fill=cluster_number), alpha=0.4, width = 0.3, shape=21,size=1) +
  scale_fill_manual("Clusters", values=cols_cluster) +
  theme_classic()+
  theme(legend.position = "none")+
  stat_summary(aes(y=`CD8_TrueNaive_per`, x=cluster_number),size=0.2)+
  labs(title="", x="", y="CD8+ True Naive (% of CD8)")
pc_2   

## CD4_TrueNaive_per
pc_3 <- ggplot(df_loop, aes(x=cluster_number, y=`CD4_TrueNaive_per`)) +
  geom_boxplot(aes(fill=cluster_number),alpha=0.9,outlier.size=0,outlier.colour="white") +
  geom_jitter(aes(fill=cluster_number), alpha=0.4, width = 0.3, shape=21,size=1) +
  scale_fill_manual("Clusters", values=cols_cluster) +
  theme_classic()+
  theme(legend.position = "none")+
  stat_summary(aes(y=`CD4_TrueNaive_per`, x=cluster_number),size=0.2)+
  labs(title="", x="", y="CD4+ True Naive (% of CD4)")
pc_3  

## CD4_Treg_per
pc_4 <- ggplot(df_loop, aes(x=cluster_number, y=`CD4_Treg_per`)) +
  geom_boxplot(aes(fill=cluster_number),alpha=0.9,outlier.size=0,outlier.colour="white") +
  geom_jitter(aes(fill=cluster_number), alpha=0.4, width = 0.3, shape=21,size=1) +
  scale_fill_manual("Clusters", values=cols_cluster) +
  theme_classic()+
  theme(legend.position = "none")+
  stat_summary(aes(y=`CD4_Treg_per`, x=cluster_number),size=0.2)+
  labs(title="", x="", y="CD4+ Treg (% of CD4)")
pc_4  

## CD4_HLADR+_per
pc_5 <- ggplot(df_loop, aes(x=cluster_number, y=`CD4_HLADR+_per`)) +
  geom_boxplot(aes(fill=cluster_number),alpha=0.9,outlier.size=0,outlier.colour="white") +
  geom_jitter(aes(fill=cluster_number), alpha=0.4, width = 0.3, shape=21,size=1) +
  scale_fill_manual("Clusters", values=cols_cluster) +
  theme_classic()+
  theme(legend.position = "none")+
  stat_summary(aes(y=`CD4_HLADR+_per`, x=cluster_number),size=0.2)+
  labs(title="", x="", y="CD4+ HLA-DR+ (% of CD4)")
pc_5  

## CD4_CD95+_per
pc_6 <- ggplot(df_loop, aes(x=cluster_number, y=`CD4_CD95+_per`)) +
  geom_boxplot(aes(fill=cluster_number),alpha=0.9,outlier.size=0,outlier.colour="white") +
  geom_jitter(aes(fill=cluster_number), alpha=0.4, width = 0.3, shape=21,size=1) +
  scale_fill_manual("Clusters", values=cols_cluster) +
  theme_classic()
+theme(legend.position = "none")+
  stat_summary(aes(y=`CD4_CD95+_per`, x=cluster_number),size=0.2)+
  labs(title="", x="", y="CD4+CD95+ (% of CD4)")
pc_6  

## CD8_CD95+_per
pc_7 <- ggplot(df_loop, aes(x=cluster_number, y=`CD8_CD95+_per`)) +
  geom_boxplot(aes(fill=cluster_number),alpha=0.9,outlier.size=0,outlier.colour="white") +
  geom_jitter(aes(fill=cluster_number), alpha=0.4, width = 0.3, shape=21,size=1) +
  scale_fill_manual("Clusters", values=cols_cluster) +
  theme_classic()+
  theme(legend.position = "none")+
  stat_summary(aes(y=`CD8_CD95+_per`, x=cluster_number),size=0.2)+
  labs(title="", x="", y="CD8+CD95+ (% of CD8)")
pc_7  

## CD8 Tem
pc_8 <- ggplot(df_loop, aes(x=cluster_number, y=`CD8_Tem_per`)) +
  geom_boxplot(aes(fill=cluster_number),alpha=0.9,outlier.size=0,outlier.colour="white") +
  geom_jitter(aes(fill=cluster_number), alpha=0.4, width = 0.3, shape=21,size=1) +
  scale_fill_manual("Clusters", values=cols_cluster) +
  theme_classic()+
  theme(legend.position = "none")+
  stat_summary(aes(y=`CD8_Tem_per`, x=cluster_number),size=0.2)+
  labs(title="", x="", y="CD8 Tem (% of CD8)")
pc_8  

## arrange plots and save
ggarrange_s <- egg::ggarrange(
  pc_1,
  pc_2,
  pc_3,
  pc_4,
  pc_5,
  pc_6,
  pc_7,
  pc_8,
  ncol = 4)
pdf(file = paste0(baseline_differences_save.dir, "Cluster_imm_ggarrange.pdf", sep=""),width = 11 , height = 6); ggarrange_s; dev.off()
```

# Statistical analysis, calculating significant subsets in immunotypes Supplementary Table 3
## immune variables, trucounts + additional subsets calculated
### dataset preparation
```{r}
## select the dataset
df_stat <- df_additional_subsets %>% 
  select(-cluster_number) %>%
  left_join(vital.truc_influ_d0_cluster, by="subject_identifier")
df_stat

## subject identifier and cluster number as.character
df_stat %<>% mutate_at(
  c("subject_identifier","cluster_number"),
  list(~as.character(.)))

## melt
df_stat_melt <- df_stat %>% 
  select(-c(fcs_file, sample_identifier,age, age_group,timepoint, timepoint_days, sex)) %>% 
  reshape2::melt(.)

### kruskal.test and Dunn's test
## With kruskal.test we identify overall which subsets are significant and then Dunn's test tells us which are different between pairs of clusters
kw.test.all <- df_stat_melt %>% 
  group_by(variable) %>% 
  kruskal_test(value ~ cluster_number) %>% 
  adjust_pvalue(method = "BH") 
kw.test.all.eff.size <- df_stat_melt %>% 
  group_by(variable) %>% 
  kruskal_effsize(value ~ cluster_number) 
combine.kw <- kw.test.all %>% 
  left_join(kw.test.all.eff.size, by="variable") %>% 
  filter(p.adj < 0.05)

## Number of variables with p.adj-value <0.05
length(combine.kw$variable)

## table summarizing effect size of the significant variables 
table(combine.kw$magnitude)

### Post-hoc analysis dunn's test, pairwise multiple comparisons to check which are significant in pairwise analysis.
dun.test.pos <- df_stat_melt %>% 
  group_by(variable) %>% 
  dunn_test(value ~ cluster_number, p.adjust.method = "BH", detailed = TRUE)
dun.test.pos <- dun.test.pos %>% 
  filter(p.adj.signif != "ns") # %>% 
  #rename(cluster_number_1 = group1) %>% 
  #rename(cluster_number_2 = group2)
head(dun.test.pos)

unique(dun.test.pos$variable)

## save as a table
writexl::write_xlsx(dun.test.pos, paste0(analysis.path, "/results/tables/dun.test.pos_ALL.xlsx", sep=""))
```

## add stat info to the boxplots
```{r}
## saving figures
df_stat %<>% mutate_at(c("cluster_number"),
  list(~factor(.)))

df<-df_stat
stat.test <-dun.test.pos

Xaxis <- df$cluster_number
n <- ncol(df)
Groups <- df$cluster_number

## linear axis loop
for (i in c(2:4,8,13:n)){ #select the column data starts 
  Yaxis <- df[[i]]
  y_title <- colnames(df[i])
  y_pos_value <- max(df[[i]])
  stat.test_x <- stat.test %>% 
    filter(variable==y_title)
  
  p<-ggplot(df, aes(x = cluster_number, y = Yaxis)) +geom_boxplot(aes(fill=cluster_number))+
    geom_boxplot(aes(fill=cluster_number), alpha=0.95)+
    geom_jitter(aes(fill=cluster_number), alpha=0.3, width = 0.3, shape=21)+
    scale_fill_manual("clusters", values=cols_cluster)+
    stat_summary()+
    theme_minimal()+
    stat_pvalue_manual(stat.test_x, y.position = y_pos_value, step.increase = 0.05,label = "p.adj.signif")+
    ylab(y_title)
  
  pdf(file = paste0(baseline_cluster_save.dir, paste("Baseline_cluster_sign_", y_title, "_linear.pdf", sep = ""), sep="") ,width = 3.5 , height = 3)
  print(p)
  dev.off()
}
```

# Influenza Post-vaccination, Importing data
```{r}
## Vital influenza trucount data
head(vital.truc_influ) ##outliers removed

## add cluster data to trucount data (all timepoints)
df_kinetics_c <- vital.truc_influ_d0_cluster %>% 
  select(cluster_number,subject_identifier) %>% 
  left_join(vital.truc_influ, by="subject_identifier")

## renaming age groups, "-" creates problems
df_kinetics_c <- df_kinetics_c %>% mutate(
  age_group = recode(age_group, "25-49" = "25_49", "50-64" = "50_64","65-98" = "65_98")) %>%
  mutate_at(c("sex","age_group","timepoint","timepoint_days","cluster_number"),
            list(~factor(.))) %>%
  mutate_at(c("fcs_file","subject_identifier","sample_identifier"),
            list(~as.character(.)))
head(df_kinetics_c)
```

# Plot immune subset kinetics for age groups and immunotypes and save the figures
## create output directory
```{r}
dir.create(file.path(analysis.path, "results/figures/age_groups_postvac_kinetics"), showWarnings = FALSE)
dir.create(file.path(analysis.path, "results/figures/cluster_postvac_kinetics"), showWarnings = FALSE)
dir.create(file.path(analysis.path, "results/figures/postvac_kinetics"), showWarnings = FALSE)

```

## plot subset kinetics
```{r}
df_kinetics_c %<>% mutate_at(c("cluster_number","sex","age_group","timepoint","timepoint"), funs(factor(.)))

###plotDynamics_ABC gives Day 0 --> Day1-2 --> Day 7

## function to plot subset kinetics for age groups
plotDynamics_agegroup_ABC(df_kinetics_c, variables = colnames(df_kinetics_c))
## function to plot subset kinetics for immunotypes
plotDynamics_cluster_ABC(df_kinetics_c, variables = colnames(df_kinetics_c))
```

## Arrange the plots Figure 6A-B & Supplementary figure 6A-C
### CD4_CXCR5+CD38+_per
```{r}
## subset CD4_CXCR5+CD38+_per
first_df <- df_kinetics_c %>% 
    dplyr::select(sample_identifier, 
                  #subject_identifier,
                  timepoint,
                  `CD4_CXCR5+CD38+_per`,
                  cluster_number,age_group) %>% 
    reshape2::melt() %>% 
    mutate(Day= ifelse(timepoint=="A", 0, ifelse(timepoint =="B", 2, ifelse(timepoint =="C", 7, NA))))

## immunotypes, kinetics
kinetics_1 <- ggplot(first_df, aes(x=as.numeric(Day), y=value, fill=cluster_number)) +
      stat_summary(geom="ribbon", alpha=0.5) +
      #annotate("label", x = 0, y = 0.5, label = "Day of vaccination")+
      geom_jitter(shape=21, size=2, alpha=0.2, width = 0.3,stroke = 0) +
      scale_fill_manual(values=group.colors_cluster) +
      #theme_biome_utils() +
      ylab("CD4 CXCR5+CD38+ (% CD4 CXCR5+)") +
      xlab("Time (days)") +
      ggtitle(paste0("Dynamics of ", "CD4_CXCR5+CD38+_per")) +
      scale_y_log10()+
      theme_classic() +
      scale_x_discrete(limits=c(0,2,7))+
      theme(legend.position='bottom')
kinetics_1

## age groups, kinetics
kinetics_2 <- ggplot(first_df, aes(x=as.numeric(Day), y=value, fill=age_group)) +
      stat_summary(geom="ribbon", alpha=0.5) +
      #annotate("label", x = 0, y = 0.5, label = "Day of vaccination")+
      geom_jitter(shape=21, size=2, alpha=0.2, width = 0.3,stroke = 0) +
      scale_fill_manual(values=group.colors_agegroup) +
      #theme_biome_utils() +
      ylab("CD4 CXCR5+CD38+ (% CD4 CXCR5+)") +
      xlab("Time (days)") +
      ggtitle(paste0("Dynamics of ", "CD4_CXCR5+CD38+_per")) +
      scale_y_log10()+
      scale_x_discrete(limits=c(0,2,7))+
      theme_classic() +
      theme(legend.position='bottom')
kinetics_2

## arrange the plots and save
ggarrange_kinetics1 <- egg::ggarrange(kinetics_2,kinetics_1 ,ncol = 2)
pdf(file = paste0("results/figures/postvac_kinetics/", "post_vac_c2_CD4_CXCR5+CD38+_per_agegroup_cluster.pdf", sep=""),width = 8 , height = 5); ggarrange_kinetics1; dev.off()
```
### CD4_CXCR5+CD38+_num
```{r}
## subset CD4_CXCR5+CD38+_num
first_df <- df_kinetics_c %>% 
    dplyr::select(sample_identifier, 
                  #subject_identifier,
                  timepoint,
                  `CD4_CXCR5+CD38+_num`,
                  cluster_number,age_group) %>% 
    reshape2::melt() %>% 
    mutate(Day= ifelse(timepoint=="A", 0, ifelse(timepoint =="B", 2, ifelse(timepoint =="C", 7, NA))))

## immunotypes, kinetics
kinetics_3 <- ggplot(first_df, aes(x=as.numeric(Day), y=value, fill=cluster_number)) +
      stat_summary(geom="ribbon", alpha=0.5) +
      #annotate("label", x = 0, y = 0.5, label = "Day of vaccination")+
      geom_jitter(shape=21, size=2, alpha=0.2, width = 0.3,stroke = 0) +
      scale_fill_manual(values=group.colors_cluster) +
      #theme_biome_utils() +
      ylab("CD4 CXCR5+CD38+ (cells/ul)") +
      xlab("Time (days)") +
      ggtitle(paste0("Dynamics of ", "CD4_CXCR5+CD38+_num")) +
      scale_y_log10()+
      theme_classic() +
      scale_x_discrete(limits=c(0,2,7))+
      theme(legend.position='bottom')
kinetics_3

## age groups, kinetics
kinetics_4 <- ggplot(first_df, aes(x=as.numeric(Day), y=value, fill=age_group)) +
      stat_summary(geom="ribbon", alpha=0.5) +
      #annotate("label", x = 0, y = 0.5, label = "Day of vaccination")+
      geom_jitter(shape=21, size=2, alpha=0.2, width = 0.3,stroke = 0) +
      scale_fill_manual(values=group.colors_agegroup) +
      #theme_biome_utils() +
      ylab("CD4 CXCR5+CD38+ (cells/ul)") +
      xlab("Time (days)") +
      ggtitle(paste0("Dynamics of ", "CD4_CXCR5+CD38+_num")) +
      scale_y_log10()+
      scale_x_discrete(limits=c(0,2,7))+
      theme_classic() +
      theme(legend.position='bottom')
kinetics_4

## arrange the plots and save
ggarrange_kinetics1 <- egg::ggarrange(kinetics_4,kinetics_3 ,ncol = 2)
pdf(file = paste0("results/figures/postvac_kinetics/", "post_vac_c2_CD4_CXCR5+CD38+_num_agegroup_cluster.pdf", sep=""),width = 8 , height = 5); ggarrange_kinetics1; dev.off()

```
### CD4_CXCR5+_per
```{r}
## subset CD4_CXCR5+_per
first_df <- df_kinetics_c %>% 
    dplyr::select(sample_identifier, 
                  #subject_identifier,
                  timepoint,
                  `CD4_CXCR5+_per`,
                  cluster_number,age_group) %>% 
    reshape2::melt() %>% 
    mutate(Day= ifelse(timepoint=="A", 0, ifelse(timepoint =="B", 2, ifelse(timepoint =="C", 7, NA))))

## immunotypes, kinetics
kinetics_5 <- ggplot(first_df, aes(x=as.numeric(Day), y=value, fill=cluster_number)) +
      stat_summary(geom="ribbon", alpha=0.5) +
      #annotate("label", x = 0, y = 0.5, label = "Day of vaccination")+
      geom_jitter(shape=21, size=2, alpha=0.2, width = 0.3,stroke = 0) +
      scale_fill_manual(values=group.colors_cluster) +
      #theme_biome_utils() +
      ylab("CD4 CXCR5+ (% CD4 CXCR5+)") +
      xlab("Time (days)") +
      ggtitle(paste0("Dynamics of ", "CD4_CXCR5+_per")) +
      scale_y_log10()+
      theme_classic() +
      scale_x_discrete(limits=c(0,2,7))+
      theme(legend.position='bottom')
kinetics_5

## age groups, kinetics
kinetics_6 <- ggplot(first_df, aes(x=as.numeric(Day), y=value, fill=age_group)) +
      stat_summary(geom="ribbon", alpha=0.5) +
      #annotate("label", x = 0, y = 0.5, label = "Day of vaccination")+
      geom_jitter(shape=21, size=2, alpha=0.2, width = 0.3,stroke = 0) +
      scale_fill_manual(values=group.colors_agegroup) +
      #theme_biome_utils() +
      ylab("CD4 CXCR5+ (% CD4 CXCR5+)") +
      xlab("Time (days)") +
      ggtitle(paste0("Dynamics of ", "CD4_CXCR5+_per")) +
      scale_y_log10()+
      scale_x_discrete(limits=c(0,2,7))+
      theme_classic() +
      theme(legend.position='bottom')
kinetics_6

## arrange the plots and save
ggarrange_kinetics1 <- egg::ggarrange(kinetics_6,kinetics_5 ,ncol = 2)
pdf(file = paste0("results/figures/postvac_kinetics/", "post_vac_c2_CD4_CXCR5+_per_agegroup_cluster.pdf", sep=""),width = 8 , height = 5); ggarrange_kinetics1; dev.off()


```
### CD4_CXCR5+_num
```{r}
## subset CD4_CXCR5+_num
first_df <- df_kinetics_c %>% 
    dplyr::select(sample_identifier, 
                  #subject_identifier,
                  timepoint,
                  `CD4_CXCR5+_num`,
                  cluster_number,age_group) %>% 
    reshape2::melt() %>% 
    mutate(Day= ifelse(timepoint=="A", 0, ifelse(timepoint =="B", 2, ifelse(timepoint =="C", 7, NA))))

## immunotypes, kinetics
kinetics_7 <- ggplot(first_df, aes(x=as.numeric(Day), y=value, fill=cluster_number)) +
      stat_summary(geom="ribbon", alpha=0.5) +
      #annotate("label", x = 0, y = 0.5, label = "Day of vaccination")+
      geom_jitter(shape=21, size=2, alpha=0.2, width = 0.3,stroke = 0) +
      scale_fill_manual(values=group.colors_cluster) +
      #theme_biome_utils() +
      ylab("CD4 CXCR5+ (cells/ul)") +
      xlab("Time (days)") +
      ggtitle(paste0("Dynamics of ", "CD4_CXCR5+_num")) +
      scale_y_log10()+
      theme_classic() +
      scale_x_discrete(limits=c(0,2,7))+
      theme(legend.position='bottom')
kinetics_7

## age groups, kinetics
kinetics_8 <- ggplot(first_df, aes(x=as.numeric(Day), y=value, fill=age_group)) +
      stat_summary(geom="ribbon", alpha=0.5) +
      #annotate("label", x = 0, y = 0.5, label = "Day of vaccination")+
      geom_jitter(shape=21, size=2, alpha=0.2, width = 0.3,stroke = 0) +
      scale_fill_manual(values=group.colors_agegroup) +
      #theme_biome_utils() +
      ylab("CD4 CXCR5+ (cells/ul)") +
      xlab("Time (days)") +
      ggtitle(paste0("Dynamics of ", "CD4_CXCR5+_num")) +
      scale_y_log10()+
      scale_x_discrete(limits=c(0,2,7))+
      theme_classic() +
      theme(legend.position='bottom')
kinetics_8

## arrange the plots and save
ggarrange_kinetics1 <- egg::ggarrange(kinetics_8,kinetics_7 ,ncol = 2)
pdf(file = paste0("results/figures/postvac_kinetics/", "post_vac_c2_CD4_CXCR5+_num_agegroup_cluster.pdf", sep=""),width = 8 , height = 5); ggarrange_kinetics1; dev.off()
```
## arrange the plots and save,figure 6 A-B
```{r}
## arrange the plots and save
ggarrange_kinetics1 <- egg::ggarrange(kinetics_2,kinetics_1,
                                      ncol = 2)
pdf(file = paste0("results/figures/postvac/", "post_vac_c2_CD4_CXCR5+CD38+_agegroup_cluster.pdf", sep=""),width = 8 , height = 5); ggarrange_kinetics1; dev.off()
```
## arrange the plots and save, supplementary figure 6 A-C
```{r}
ggarrange_kinetics1 <- egg::ggarrange(kinetics_4,kinetics_3,
                                      kinetics_6,kinetics_5,
                                      kinetics_8,kinetics_7,
                                      ncol = 2)
pdf(file = paste0("results/figures/postvac_kinetics/", "post_vac_fig6s_cluster.pdf", sep=""),width = 8 , height = 15); ggarrange_kinetics1; dev.off()
```
# Calculating post vaccination fold changes for each individual
## data import
```{r}
## Import raw data, outliers that were removed for clustering are included
vital.truc_influ <- read_excel("VITAL_database.xlsx",
                               sheet = "trucount_influenza_vac",
                               skip = 1) %>% 
  mutate_at(c("sex","age_group","timepoint","timepoint_days"), list(~factor(.))) %>%
  mutate_at(c("subject_identifier"), list(~as.character(.))) %>%
```

## create output folder
```{r}
dir.create(file.path(analysis.path, "results/figures/postvac"),showWarnings = FALSE)

dir.create(file.path(analysis.path, "results/figures/postvac/age_group"),showWarnings = FALSE)
postvac_agegroup_save.dir <- file.path(analysis.path, "/results/figures/postvac/age_group/")

dir.create(file.path(analysis.path, "results/figures/postvac/cluster"),showWarnings = FALSE)
postvac_cluster_save.dir <- file.path(analysis.path, "/results/figures/postvac/cluster/")
```

## immune subset kinetics Day0 between Day7
```{r}
#### Day 7 vs Day0 ####
df_kinetics_D0D7 <- vital.truc_influ %>% 
  filter(timepoint_days %in% c("Day 0","Day 7") )

## identifying subject IDs with both Day0 and Day7 data points
subject_ID_D0D7 <- df_kinetics_D0D7[duplicated(df_kinetics_D0D7$subject_identifier),]$subject_identifier

## removing the subject IDs that do not contain both D0D7 data
print("dims before non-D0D7 datapoints removed") ; dim(df_kinetics_D0D7)
df_kinetics_D0D7 <- df_kinetics_D0D7[(df_kinetics_D0D7$subject_identifier %in% subject_ID_D0D7),]
print("dims after non-D0D7 datapoints removed") ; dim(df_kinetics_D0D7)

## subset the day 0 and day 7 data
df_kinetics_D0 <- df_kinetics_D0D7 %>% 
  filter(timepoint_days %in% c("Day 0"))
df_kinetics_D7 <- df_kinetics_D0D7 %>% 
  filter(timepoint_days %in% c("Day 7"))

## check if the IDs match
print("Do the subject IDs match?");all.equal(df_kinetics_D0$subject_identifier,df_kinetics_D7$subject_identifier)

## calculate the log2 fold change
df_kinetics_D7_D0 <- as.data.frame(c()) ## set as a dataframe
df_kinetics_D7_D0 <- df_kinetics_D0[c(1:8)] ## add participant data
df_kinetics_D7_D0[c(9:214)] <- log2(df_kinetics_D7[c(9:214)]/df_kinetics_D0[c(9:214)]) ## calculate the fold changes
df_kinetics_D7_D0_influ_log2fc <- df_kinetics_D7_D0 %>% 
  select(-c(fcs_file,sample_identifier,timepoint,timepoint_days)) ##remove non-necessary columns 

## join the cluster data and day 0, day 7 fold change data
df_kinetics_D7_D0_influ_log2fc_cluster <- vital.truc_influ_d0_cluster %>% 
  select(subject_identifier,cluster_number) %>%
  left_join(df_kinetics_D7_D0_influ_log2fc,by="subject_identifier")
```

## D0-D7 mean cluster kinetics for CD4 CXCR5+ CD38+
```{r}
## CD4 CXCR5+ CD38+ fc
fc_plot  <- df_kinetics_D7_D0_influ_log2fc_cluster %>% group_by(cluster_number) %>% 
  summarise(log2fc_subset= mean(`CD4_CXCR5+CD38+_per`, na.rm = TRUE)) %>%
  mutate(name = fct_reorder(cluster_number, log2fc_subset)) %>%
  ggplot( aes(x=name, y=log2fc_subset)) +
  geom_segment( aes(xend=name, yend=0)) +
  geom_point( size=3, color="orange") + theme_bw() +coord_flip() +
  labs(title="D7/D0 fc log2")
fc_plot

## save pdf
pdf(file = paste0("results/figures/postvac/", "CD4_CXCR5+CD38+_per_mean.pdf", sep=""), width =4 , height =4) ; fc_plot ; dev.off()
```

## D0-D7 log2fc in groups for every subset
```{r}
### boxplot age groups ~ immune parameters
## saving figures
df_loop <- df_kinetics_D7_D0_influ_log2fc
Xaxis <- df_loop$age_group
n <- ncol(df_loop)
Groups <- df_loop$age_group

## linear axis loop
for (i in c(5:n)){ #select the column data starts 
  Yaxis <- df_loop[[i]]
  y_title <- colnames(df_loop[i])
  p <- boxplot_agegroups()+labs(title="",x="Age group",y = y_title)
  pdf(file = paste0(postvac_agegroup_save.dir, paste("D0D7_agegroup_", y_title, "_linear.pdf", sep = ""), sep="") ,width = 3.5 , height = 3)
  print(p)
  dev.off()
}

# ## log axis loop
# for (i in c(5,11:n)){
#   Yaxis <- df_loop[[i]]
#   y_title <- colnames(df_loop[i])
#   p <- boxplot_agegroups_log()+labs(title="",x="Age group",y = y_title)
# 
#   pdf(file = paste0(postvac_agegroup_save.dir, paste("D0D7_agegroup_", y_title, "_log.pdf", sep = ""), sep="") ,width = 3.5 , height = 3)
#   print(p)
#   dev.off()
# }
```

## D0-D7 log2fc in immunotypes for every subset
```{r}
### boxplot immunotypes ~ immune parameters
## saving figures
df_loop <- df_kinetics_D7_D0_influ_log2fc_cluster
Xaxis <- df_loop$cluster_number
n <- ncol(df_loop)
Groups <- df_loop$cluster_number

## linear axis loop
for (i in c(5,11:n)){ #select the column data starts 
  Yaxis <- df_loop[[i]]
  y_title <- colnames(df_loop[i])
  p <- boxplot_cluster()+labs(title="",x="Clusters",y = y_title)
  pdf(file = paste0(postvac_cluster_save.dir, paste("D0D7_cluster_", y_title, "_linear.pdf", sep = ""), sep="") ,width = 3.5 , height = 3)
  print(p)
  dev.off()
}

# ## log axis loop
# for (i in c(5,11:n)){ #select the column data starts
#   Yaxis <- df_loop[[i]]
#   y_title <- colnames(df_loop[i])
#   p <- boxplot_cluster_log()+labs(title="",x="Clusters",y = y_title)
# 
#   pdf(file = paste0(postvac_cluster_save.dir, paste("D0D7_cluster_", y_title, "_log.pdf", sep = ""), sep="") ,width = 3.5 , height = 3)
#   print(p)
#   dev.off()
# }
```

# ####### Immune system cell subset stability and heterogeneity
# Immune Stability
## Importing data, shared T0 & T5 donors
```{r}
## importing dataset, baseline for influenza (T0) and pneumococcal (T5) vaccinations, shared donors, shared variables
head(vital.truc_influ_d0)

vital.truc_influ_d0_stability <- vital.truc_influ_d0 %>% 
  filter(subject_identifier %!in% c("46", "229", "256", "312","62","171")) #remove technical outliers

vital.truc_pneum_d0_stability <- read_excel("VITAL_database.xlsx",
                               sheet = "trucount_pneumococcal_vac",
                               skip = 1) %>% 
  filter(timepoint_days %in% "Day 0") %>% 
  mutate_at(c("subject_identifier"), list(~as.character(.))) %>%
  mutate_at(c("age_group","timepoint","timepoint_days","sex"), list(~factor(.)))%>%
  filter(subject_identifier %!in% c("46", "229", "256", "312","62","171"))
```

## subset donors with both influenza and pneumococcal baseline
```{r}
## T0 and T5 subject_identifiers
influ_D0_ID <- vital.truc_influ_d0_stability$subject_identifier
pneum_D0_ID <- vital.truc_pneum_d0_stability$subject_identifier

## shared subject_identifiers
influ_pneum_D0_ID <- intersect(influ_D0_ID,pneum_D0_ID)

## T0 and T5 variables
influ_D0_var <- colnames(vital.truc_influ_d0_stability)
pneum_D0_var <- colnames(vital.truc_pneum_d0_stability)

## shared variables
influ_pneum_D0_var <- intersect(influ_D0_var,pneum_D0_var)

## shared immune variables
vital.truc_influ_d0_sub <- vital.truc_influ_d0_stability %>% 
  select(all_of(influ_pneum_D0_var))
vital.truc_pneum_d0_sub <- vital.truc_pneum_d0_stability %>% 
  select(all_of(influ_pneum_D0_var))

## subst shared subject identifiers
vital.truc_influ_d0_sub <- vital.truc_influ_d0_sub %>% 
  filter(subject_identifier %in% influ_pneum_D0_ID)
vital.truc_pneum_d0_sub <- vital.truc_pneum_d0_sub %>% 
  filter(subject_identifier %in% influ_pneum_D0_ID)

## merge influ and pneum databases
influ_pneum_D0 <- rbind(vital.truc_influ_d0_sub,vital.truc_pneum_d0_sub)

## subset participant data
participant.data_T0T5 <- influ_pneum_D0[,c(1:8)] %>% 
  as.data.frame() %>% 
  mutate_at(c("age_group","timepoint","timepoint_days","sex"), list(~as.factor(.)))
head(participant.data_T0T5)

## subset immune data
immune.data_T0T5 <- influ_pneum_D0[,-c(1:8)] %>% as.data.frame()
head(immune.data_T0T5)

## make sample ids rownames
rownames(immune.data_T0T5) <- influ_pneum_D0$sample_identifier
```

## Immune Stability calculation
### create output folder
```{r}
## create output folder
dir.create(file.path(analysis.path, "results/figures/stability"),showWarnings = FALSE)
stability.dir <- file.path(analysis.path, "results/figures/stability/")
```

### calculate immune stability
```{r}
## calculate T0~T5 correlation between
influ_pneum.corr_T0T5 <- cor(t(immune.data_T0T5), method = "spearman") %>% 
  reshape2::melt() %>%
    dplyr::rename( S1 = "Var1", S2 = "Var2") %>%
    dplyr::left_join(participant.data_T0T5, by = c("S1" = "sample_identifier")) %>%
    dplyr::left_join(participant.data_T0T5, by = c("S2" = "sample_identifier"), suffix = c("_S1", "_S2")) %>%
    dplyr::filter(S1!=S2)

## keep only paired correlations  %>% filter(subject_identifier_S1 == subject_identifier_S2)
influ_pneum.corr.T0T5_IDs <- influ_pneum.corr_T0T5 %>% 
  filter(subject_identifier_S1 == subject_identifier_S2) %>% 
  mutate(comparison= paste0(subject_identifier_S1, " vs ", subject_identifier_S2)) %>% 
  filter(!grepl('406E', S2)) %>% 
  select(c(S1,S2,value,subject_identifier_S1,subject_identifier_S2,age_S1,age_S2,age_group_S2,sex_S2,age_group_S1,sex_S1))

## plot the data
require("ggrepel")
Spearman_intradonor_T0T5_plot <- influ_pneum.corr.T0T5_IDs %>% arrange(age_S1) %>%
  ggplot(aes(age_S1, value,label = subject_identifier_S1)) +
  geom_point() + geom_smooth()+ geom_text_repel(size=2)+
  theme_classic() +
  xlab("Age") +
  ylab("pre-influenza and pneumococcal vaccination baseline correlation (spearman)") +
  labs(subtitle = "Immune system stability")
Spearman_intradonor_T0T5_plot

pdf(file = paste0(stability.dir, "Spearman_intradonor_T0T5_ada_inn.pdf", sep=""), width =6 , height =4) ; Spearman_intradonor_T0T5_plot ; dev.off()

## plot the data without subject_identifiers
m <- influ_pneum.corr.T0T5_IDs %>% arrange(age_S1) %>%
  ggplot(aes(age_S1, value,label = subject_identifier_S1)) +
  geom_point(alpha=0.30) + geom_smooth()+ 
  theme_classic() +
  xlab("Age") +
  ylab("pre-influenza and pneumococcal vaccination baseline correlation (spearman)") +
  labs(subtitle = "Correlation of pre-vaccination parameters of individuals between influenza and pneumococcal vaccinations")
m
pdf(file = paste0(stability.dir, "Spearman_intradonor_T0T5_ada_inn_withoutIDs.pdf", sep=""), width =5 , height =3) ; m ; dev.off()

## plot the data stability ordered Figure 5A
m <-influ_pneum.corr.T0T5_IDs %>%
  mutate(name = fct_reorder(subject_identifier_S1, value)) %>%
  ggplot(aes(x=name, y=value, color=age_group_S1)) +
  geom_point(alpha=0.5,size=2.5) + scale_color_manual(values=c("#F0E442", "#85C0F9", "#F5793A"))+
  theme_classic() + 
  theme(legend.position='bottom',
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
m

pdf(file = paste0(stability.dir, "Spearman_intradonor_T0T5_ordered_ada_inn.pdf", sep=""), width =9 , height =3) ; m ; dev.off()
```

### Save immune  stability dataset
```{r}
## Save immune system stability dataset
immune_stability_T0T5 <- influ_pneum.corr.T0T5_IDs %>%
  dplyr::rename(sample_identifier=S2,subject_identifier=subject_identifier_S1,stability_corr=value) %>% 
  select(subject_identifier, stability_corr) %>% 
  mutate_at(c("subject_identifier"), list(~as.character(.)))
```

## Stability in age groups, immunotypes, CMV, EBV, sex
### Dataset organization
```{r}
## Datasets 
head(vital.truc_influ_d0_cluster)
head(immune_stability_T0T5)
head(chronic_viral_inf)

## stability & chronic viral infection 
Dat_stability_CVI <- participant.data_T0T5 %>% 
  filter(timepoint %in% "A") %>% 
  select(subject_identifier,sex,age,age_group) %>% 
  left_join(immune_stability_T0T5, by="subject_identifier") %>%
  left_join(chronic_viral_inf, by="subject_identifier")
Dat_stability_CVI

## stability & cluster and immune subsets 
Dat_stability_cluster <- immune_stability_T0T5 %>% 
  left_join(vital.truc_influ_d0_cluster, by="subject_identifier") %>% 
  filter(!is.na(cluster_number))

## stability & post vaccination log2 fc
Dat_kinetics_stability <- immune_stability_T0T5 %>% 
  left_join(df_kinetics_D7_D0_influ_log2fc, by="subject_identifier")
```

### Immune stability in sex, CMV, EBV, immunotypes, age group and the plots (+statistical analysis)
#### immunotypes
```{r}
## stability in immunotypes #########
kruskal.test(stability_corr ~ cluster_number, data = Dat_stability_cluster) 

kw.test.all <- Dat_stability_cluster %>% 
  kruskal_test(stability_corr ~ cluster_number) %>% adjust_pvalue(method = "BH") 
kw.test.all.eff.size <- Dat_stability_cluster %>% kruskal_effsize(stability_corr ~ cluster_number) 
combine.kw <- kw.test.all %>% 
  left_join(kw.test.all.eff.size, by=".y.") %>%
  filter(p.adj < 0.05)

### Post-hoc analysis dunn's test
dun.test.pos <- Dat_stability_cluster %>% 
  dunn_test(stability_corr ~ cluster_number, p.adjust.method = "BH", detailed = TRUE)
dun.test.pos <- dun.test.pos %>% filter(p.adj.signif != "ns")
head(dun.test.pos)

## plot stability in immunotypes + statistics
ps1 <- Dat_stability_cluster %>% ggplot( aes(x=cluster_number, y=stability_corr)) +
  geom_boxplot(aes(fill=cluster_number), alpha=0.9,outlier.size=0,outlier.colour="white") +
  geom_jitter(aes(fill=cluster_number), alpha=0.2, width = 0.3, shape=21,size=1) +
  scale_fill_manual("Clusters", values=cols_cluster) +
  theme_classic()+
  theme(legend.position='none')+
  xlab("")+
  ylab("immune stability (r)")+
  stat_summary()+
  stat_pvalue_manual(dun.test.pos, y.position = max(Dat_stability_cluster$stability_corr), step.increase = 0.05,label = "p.adj.signif",hide.ns = TRUE)+
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
ps1


## plot stability in immunotypes without statistics ## Figure 5G
ps1_s <- Dat_stability_cluster %>% ggplot( aes(x=cluster_number, y=stability_corr)) +
  geom_boxplot(aes(fill=cluster_number), alpha=0.9,outlier.size=0,outlier.colour="white") +
  geom_jitter(aes(fill=cluster_number), alpha=0.2, width = 0.3, shape=21,size=1) +
  scale_fill_manual("Clusters", values=cols_cluster) +
  theme_classic()+
  theme(legend.position='none')+
  xlab("")+
  ylab("immune stability (r)")+
  stat_summary()
ps1_s
```

#### age groups
```{r}
## stability in age groups ########
kruskal.test(stability_corr ~ age_group, data = Dat_stability_CVI) 

kw.test.all <- Dat_stability_CVI %>% 
  kruskal_test(stability_corr ~ age_group) %>% adjust_pvalue(method = "BH") 
kw.test.all.eff.size <- Dat_stability_CVI %>% kruskal_effsize(stability_corr ~ age_group) 
combine.kw <- kw.test.all %>% left_join(kw.test.all.eff.size, by=".y.") %>%
  filter(p.adj < 0.05)

### Post-hoc analysis dunn's test
dun.test.pos <- Dat_stability_CVI %>% dunn_test(stability_corr ~ age_group, p.adjust.method = "BH", detailed = TRUE)
dun.test.pos <- dun.test.pos %>% filter(p.adj.signif != "ns")
head(dun.test.pos)

## plot stability in age groups + statistics # Figure 5C
ps2 <- Dat_stability_CVI %>% ggplot( aes(x=age_group, y=stability_corr)) +
  geom_boxplot(aes(fill=age_group), alpha=0.9,outlier.size=0,outlier.colour="white") +
  geom_jitter(aes(fill=age_group), alpha=0.2, width = 0.3, shape=21,size=1) +
  scale_fill_manual("Age groups", values=cols_agegroup) +
  theme_classic()+
  theme(legend.position='none')+
  xlab("")+
  ylab("Intra-individual variation (r )")+
  stat_summary()+
  stat_pvalue_manual(dun.test.pos, y.position = max(Dat_stability_CVI$stability_corr), step.increase = 0.05,label = "p.adj.signif",hide.ns = TRUE)+
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
ps2
```

#### CMV
```{r}
## stability in CMV infection ########

## remove borderline casees
Dat_stability_CVI_CMV <- Dat_stability_CVI %>%  filter(MIA_CMV_Seropositivity %in% c("1","2")) 

## reorder factors
Dat_stability_CVI_CMV$MIA_CMV_Seropositivity <- factor(Dat_stability_CVI_CMV$MIA_CMV_Seropositivity, levels = c("2","1"))

kruskal.test(stability_corr ~ MIA_CMV_Seropositivity, data = Dat_stability_CVI_CMV) 

kw.test.all <- Dat_stability_CVI_CMV %>% 
  kruskal_test(stability_corr ~ MIA_CMV_Seropositivity) %>% adjust_pvalue(method = "BH") 
kw.test.all.eff.size <- Dat_stability_CVI_CMV %>% kruskal_effsize(stability_corr ~ MIA_CMV_Seropositivity) 
combine.kw <- kw.test.all %>% left_join(kw.test.all.eff.size, by=".y.") %>%
  filter(p.adj < 0.05)

### Post-hoc analysis dunn's test
dun.test.pos <- Dat_stability_CVI_CMV %>% dunn_test(stability_corr ~ MIA_CMV_Seropositivity, p.adjust.method = "BH", detailed = TRUE)
dun.test.pos <- dun.test.pos %>% filter(p.adj.signif != "ns")
head(dun.test.pos)

## plot stability in CMV + statistics # Figure 5E
ps3 <- Dat_stability_CVI_CMV %>% ggplot( aes(x=MIA_CMV_Seropositivity, y=stability_corr)) +
  geom_boxplot(aes(fill=MIA_CMV_Seropositivity), alpha=0.9,outlier.size=0,outlier.colour="white") +
  geom_jitter(aes(fill=MIA_CMV_Seropositivity), alpha=0.2, width = 0.3, shape=21,size=1) +
  scale_fill_manual(values = c("#E69F00","#56B4E9"),name = "CMV seropositivity", labels = c("CMV+","CMV-"))+
  theme_classic()+
  theme(legend.position='none')+
  xlab("")+
  ylab("Intra-individual variation (r )")+
  stat_summary()+
  stat_pvalue_manual(dun.test.pos, y.position = max(Dat_stability_CVI_CMV$stability_corr), step.increase = 0.05,label = "p.adj.signif",hide.ns = TRUE)+
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
ps3
```

#### EBV
```{r}
## stability in EBV infection (all CMV-) ########

## Subset EBV- and EBV+ (in CMV-)
Dat_stability_CVI_EBV_CMV <- Dat_stability_CVI %>% 
  filter(CMV_EBV_combined %in% c("CMV-EBV-","CMV-EBV+"))  %>% 
  mutate_at(c("CMV_EBV_combined"), list(~as.character(.)))

## reorder factors
Dat_stability_CVI_EBV_CMV$CMV_EBV_combined <- factor(Dat_stability_CVI_EBV_CMV$CMV_EBV_combined, levels = c("CMV-EBV-","CMV-EBV+"))

kruskal.test(stability_corr ~ CMV_EBV_combined, data = Dat_stability_CVI_EBV_CMV) 

kw.test.all <- Dat_stability_CVI_EBV_CMV %>% 
  kruskal_test(stability_corr ~ CMV_EBV_combined) %>% adjust_pvalue(method = "BH") 
kw.test.all.eff.size <- Dat_stability_CVI_EBV_CMV %>% kruskal_effsize(stability_corr ~ CMV_EBV_combined) 
combine.kw <- kw.test.all %>% left_join(kw.test.all.eff.size, by=".y.") %>%
  filter(p.adj < 0.05)

### Post-hoc analysis dunn's test
dun.test.pos <- Dat_stability_CVI_EBV_CMV %>% dunn_test(stability_corr ~ CMV_EBV_combined, p.adjust.method = "BH", detailed = TRUE)
dun.test.pos <- dun.test.pos %>% filter(p.adj.signif != "ns")
head(dun.test.pos)

## plot stability in EBV + statistics #Figure 5F
ps4 <- Dat_stability_CVI_EBV_CMV %>% ggplot( aes(x=CMV_EBV_combined, y=stability_corr)) +
  geom_boxplot(aes(fill=CMV_EBV_combined), alpha=0.9,outlier.size=0,outlier.colour="white") +
  geom_jitter(aes(fill=CMV_EBV_combined), alpha=0.2, width = 0.3, shape=21,size=1) +
  scale_fill_manual(values = c("#E69F00","#56B4E9"),name = "CMV-EBV seropositivity", labels = c("CMV+EBV+","CMV+EBV-"))+
  theme_classic()+
  theme(legend.position='none')+
  xlab("")+
  ylab("Intra-individual variation (r )")+
  stat_summary()+
  stat_pvalue_manual(dun.test.pos, y.position = max(Dat_stability_CVI_EBV_CMV$stability_corr), step.increase = 0.05,label = "p.adj.signif",hide.ns = TRUE)+
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
ps4
```

#### sex differences
```{r}
## stability in sex differences ########
kruskal.test(stability_corr ~ sex, data = Dat_stability_CVI) 

kw.test.all <- Dat_stability_CVI %>% 
  kruskal_test(stability_corr ~ sex) %>% adjust_pvalue(method = "BH") 
kw.test.all.eff.size <- Dat_stability_CVI %>% kruskal_effsize(stability_corr ~ sex) 
combine.kw <- kw.test.all %>% left_join(kw.test.all.eff.size, by=".y.") %>%
  filter(p.adj < 0.05)

### Post-hoc analysis dunn's test
dun.test.pos <- Dat_stability_CVI %>% dunn_test(stability_corr ~ sex, p.adjust.method = "BH", detailed = TRUE)
dun.test.pos <- dun.test.pos %>% filter(p.adj.signif != "ns")
head(dun.test.pos)

## plot stability in sex + statistics # Figure 5D
ps5 <- Dat_stability_CVI %>% ggplot( aes(x=sex, y=stability_corr)) +
  geom_boxplot(aes(fill=sex), alpha=0.9,outlier.size=0,outlier.colour="white") +
  geom_jitter(aes(fill=sex), alpha=0.2, width = 0.3, shape=21,size=1) +
  scale_fill_manual(values = c("#E69F00","#56B4E9"),name = "Sex status", labels = c("Male", "Female"))+
  theme_classic()+
  theme(legend.position='none')+
  xlab("")+
  ylab("Intra-individual variation (r )")+
  stat_summary()+
  stat_pvalue_manual(dun.test.pos, y.position = max(Dat_stability_CVI$stability_corr), step.increase = 0.05,label = "p.adj.signif",hide.ns = TRUE)+
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
ps5
```

#### align the plots and save Figure 5A, 5C-G
```{r}

ggarrange_3b <- egg::ggarrange(m,ps2, widths = c(3,1) ,ncol = 2)
pdf(file = paste0(stability.dir, "Stability_ggarrange1_ada_inn.pdf", sep=""),width = 8 , height = 3); ggarrange_3b; dev.off()


ggarrange_3a <- egg::ggarrange(ps5,ps3,ps4, ncol = 3)
pdf(file = paste0(stability.dir, "Stability_ggarrange2_ada_inn.pdf", sep=""),width = 8 , height = 3); ggarrange_3a; dev.off()

ggarrange_3c <- egg::ggarrange(ps1,ps1_s,widths = c(1,1), ncol = 2)
pdf(file = paste0(stability.dir, "Stability_ggarrange3_ada_inn.pdf", sep=""),width = 8 , height = 4); ggarrange_3c; dev.off()

```

## Stability post-vaccination kinetics (correlation plots) Figure 5B, Figure 6D
```{r}
## select variables to be plotted
x_title <- c(
"CD4_CXCR5+CD38+_per",
"age"
)

## loop to save the stability  - subset kinetics and age - subset kinetics
for (i in x_title) {
  scatterplot1 <- ggscatter(Dat_kinetics_stability, x = i, y = "stability_corr",alpha = 0.2,
     add = "reg.line",  # Add regression line
     add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
     conf.int = FALSE # Add confidence interval
     )+stat_cor(method = "spearman",p.accuracy = 0.001, r.accuracy = 0.01)
  scatterplot1

  pdf(file = paste0(stability.dir, paste("Scatterplot_stability_",i,"_ada_inn.pdf", sep = "")),width = 3.5 , height = 3)
  print(scatterplot1)
  dev.off()
  
   scatterplot2 <- ggscatter(Dat_kinetics_stability, x = i, y = "age",alpha = 0.2,
     add = "reg.line",  # Add regression line
     add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
     conf.int = FALSE # Add confidence interval
     )+stat_cor(method = "spearman",p.accuracy = 0.001, r.accuracy = 0.01)
  scatterplot2

  pdf(file = paste0(stability.dir, paste("Scatterplot_age_",i,"_ada_inn.pdf", sep = "")),width = 3.5 , height = 3)
  print(scatterplot2)
  dev.off()
}
```

## Calculating time between ~1 year sampling and its correlation with immune subset stability Supplementary Figure 5
```{r}
# select baseline and 1 year timepoint samples
vital.sample.T0T5 <- vital.sample %>% 
  filter(collection_timepoint %in% c("A","E"))

## select the samples that both have timepoint A & E
vital.sample.T0T5_subjects <- vital.sample.T0T5[duplicated(vital.sample.T0T5$subject_identifier),]$subject_identifier

## subset the samples that both have timepoint A & E
vital.sample.T0T5 <- vital.sample.T0T5 %>% 
  filter(subject_identifier %in% vital.sample.T0T5_subjects)

## subset timepoint A & E samples
vital.sample.T0 <- vital.sample.T0T5 %>% 
  filter(collection_timepoint %in% c("A")) %>% 
  arrange(subject_identifier)
vital.sample.T5 <-vital.sample.T0T5 %>% 
  filter(collection_timepoint %in% c("E")) %>% 
  arrange(subject_identifier)

## calculate the time difference between A and E per sample
vital.sample.T0T5$collection_time_diff <- vital.sample.T5$collection_day -vital.sample.T0$collection_day 
vital.sample.T0T5 <- vital.sample.T0T5 %>% 
  select(subject_identifier,collection_time_diff,collection_timepoint) %>% 
  filter(collection_timepoint == "A") %>%
  select(-collection_timepoint)

vital.sample.T0T5_stability <- vital.sample.T0T5 %>% left_join(immune_stability_T0T5, by="subject_identifier") %>% filter(subject_identifier %!in% c("46", "229", "256", "312","62","171"))

## plot the stability & days between sampling
scatterplot1 <- vital.sample.T0T5_stability %>% 
  ggscatter( x = "collection_time_diff", y = "stability_corr", add = "reg.line", conf.int = FALSE ,cor.method = "spearman", rug=FALSE, alpha = 0.1)+
  stat_cor()+
  xlab("Time between baseline timepoints (days)")+
  ylab("Intra-donor variation in ~1 year")

## save
pdf(file = paste0(stability.dir,paste("T0T5_sampling_time.pdf", sep = "")),width = 4 , height = 3); scatterplot1; dev.off()
```

# Immune Heterogeneity
## Heterogeneity calculations (T0 samples only)
### create output folder
```{r}
## create output folder
dir.create(file.path(analysis.path, "results/figures/heterogeneity"),showWarnings = FALSE)
heterogeneity.dir <- file.path(analysis.path, "results/figures/heterogeneity/")
```

### data organization
```{r}
head(vital.truc_influ_d0)

## chronic viral infection & day 0 trucount data
vital.truc_influ_d0_CVI <- vital.truc_influ_d0 %>% 
  left_join(chronic_viral_inf, by="subject_identifier") %>% 
  filter(subject_identifier %!in% c("46", "229", "256", "312","62","171")) ##remove technical outliers

## Get participant data
participant.data_T0 <- dplyr::select(vital.truc_influ_d0_CVI, -dplyr::contains(c("_num","_per"))) %>%
  as.data.frame()
head(participant.data_T0)

## Get immune data
immune.data_T0 <- dplyr::select(vital.truc_influ_d0_CVI, dplyr::contains(c("_per","_num"))) %>%
  as.data.frame()
head(immune.data_T0)

## make sample ids rownames
rownames(immune.data_T0) <- vital.truc_influ_d0_CVI$sample_identifier
rownames(participant.data_T0) <- vital.truc_influ_d0_CVI$sample_identifier
```

### calculate heterogeneity
```{r}
## calculate correlation of samples with each other (all combinations T0) 
influ.corr_T0 <- cor(t(immune.data_T0), method = "spearman") %>% 
  reshape2::melt() %>%
    dplyr::rename( S1 = "Var1", S2 = "Var2") %>%
    dplyr::left_join(participant.data_T0, by = c("S1" = "sample_identifier")) %>%
    dplyr::left_join(participant.data_T0, by = c("S2" = "sample_identifier"), suffix = c("_S1", "_S2")) %>%
    dplyr::filter(S1!=S2)
```

### calculate heterogeneity, intra-group, sex differences Figure 3D
```{r}
## calculate correlations within the groups, (males - females) ####
influ.corr.T0_sex <- influ.corr_T0 %>% 
  filter(subject_identifier_S1 != subject_identifier_S2) %>% 
  mutate(comparison= paste0(sex_S1, " vs ", sex_S2)) %>% 
  group_by(S2, comparison) %>% 
  summarise(within.mean.dist=mean(value, na.rm = TRUE)) %>% 
  filter(comparison %in% c("1 vs 1","2 vs 2")) %>%
  mutate_at(c("comparison"), list(~factor(.))) %>%
  as.data.frame() 

## heterogeneity in sex differences 
kruskal.test(within.mean.dist ~ comparison, data = influ.corr.T0_sex) 

kw.test.all <- influ.corr.T0_sex %>% 
  kruskal_test(within.mean.dist ~ comparison) %>% 
  adjust_pvalue(method = "BH") 
kw.test.all.eff.size <- influ.corr.T0_sex %>% 
  kruskal_effsize(within.mean.dist ~ comparison) 
combine.kw <- kw.test.all %>% 
  left_join(kw.test.all.eff.size, by=".y.") %>%
  filter(p.adj < 0.05)

### Post-hoc analysis dunn's test
dun.test.pos <- influ.corr.T0_sex %>% 
  dunn_test(within.mean.dist ~ comparison, p.adjust.method = "BH", detailed = TRUE)
dun.test.pos <- dun.test.pos %>% 
  filter(p.adj.signif != "ns")
head(dun.test.pos)

## plot heterogeneity in sex differences + statistics
p1 <- influ.corr.T0_sex %>% 
  ggplot( aes(x=comparison, y=within.mean.dist)) +
  geom_boxplot(aes(fill=comparison), alpha=0.9,outlier.size=0,outlier.colour="white") +
  geom_jitter(aes(fill=comparison), alpha=0.2, width = 0.3, shape=21,size=1) +
  scale_fill_manual(values = c("#E69F00","#56B4E9"),name = "Sex status", labels = c("Male", "Female"))+
  theme_classic()+
  xlab("")+
  ylab("Intra-group correlation (Spearman's r)")+
  theme(legend.position='none')+
  stat_summary()+
  stat_pvalue_manual(dun.test.pos, y.position = max(influ.corr.T0_sex$within.mean.dist), step.increase = 0.05,label = "p.adj.signif",hide.ns = TRUE)+
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
p1

pdf(file = paste0(heterogeneity.dir,"Heterogeneity_T0_influ_intra_sex_ada_inn.pdf"), width = 3.5 , height = 3.5); p1  ; dev.off()
```

### calculate heterogeneity, intra-group, age groups Figure 3C
```{r}
## calculate correlations within age groups ####
influ.corr.T0_agegroup <- influ.corr_T0 %>% 
  filter(subject_identifier_S1 != subject_identifier_S2) %>% 
  mutate(comparison= paste0(age_group_S1, " vs ", age_group_S2)) %>% 
  group_by(S2, comparison) %>% 
  summarise(within.mean.dist=mean(value, na.rm = TRUE)) %>% 
  filter(comparison %in% c("25-49 vs 25-49","50-64 vs 50-64", "65-98 vs 65-98")) %>% 
  mutate_at(c("comparison"), list(~factor(.))) %>%
  as.data.frame() 

influ.corr.T0_agegroup$comparison <- factor(influ.corr.T0_agegroup$comparison, levels = c("25-49 vs 25-49","50-64 vs 50-64", "65-98 vs 65-98"))


## heterogeneity in age group
kruskal.test(within.mean.dist ~ comparison, data = influ.corr.T0_agegroup) 

kw.test.all <- influ.corr.T0_agegroup %>% 
  kruskal_test(within.mean.dist ~ comparison) %>% 
  adjust_pvalue(method = "BH") 
kw.test.all.eff.size <- influ.corr.T0_agegroup %>% 
  kruskal_effsize(within.mean.dist ~ comparison) 
combine.kw <- kw.test.all %>% left_join(kw.test.all.eff.size, by=".y.") %>%
  filter(p.adj < 0.05)

### Post-hoc analysis dunn's test
dun.test.pos <- influ.corr.T0_agegroup %>% dunn_test(within.mean.dist ~ comparison, p.adjust.method = "BH", detailed = TRUE)
dun.test.pos <- dun.test.pos %>% filter(p.adj.signif != "ns")
head(dun.test.pos)

## plot heterogeneity in sex differences + statistics
p2 <- influ.corr.T0_agegroup %>% 
  ggplot( aes(x=comparison, y=within.mean.dist)) +
  geom_boxplot(aes(fill=comparison), alpha=0.9,outlier.size=0,outlier.colour="white") +
  geom_jitter(aes(fill=comparison), alpha=0.2, width = 0.3, shape=21,size=1) +
  scale_fill_manual("Age groups", values=c("25-49 vs 25-49" = "#F0E442", "50-64 vs 50-64" = "#85C0F9", "65-98 vs 65-98" = "#F5793A")) +
  theme_classic()+
  xlab("")+
  ylab("Intra-group correlation (Spearman's r)")+
  theme(legend.position='none')+
  stat_summary()+
  stat_pvalue_manual(dun.test.pos, y.position = max(influ.corr.T0_agegroup$within.mean.dist), step.increase = 0.05,label = "p.adj.signif",hide.ns = TRUE)+
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
p2
  

pdf(file = paste0(heterogeneity.dir,"Heterogeneity_T0_influ_intra_agegroup_ada_inn.pdf"), width = 4 , height = 3.5); p2 ; dev.off()
```

### calculate heterogeneity, intra-group, CMV Figure 3E
```{r}
## calculate correlations within the groups, (CMV+ - CMV-)
influ.corr.T0_CMV <- influ.corr_T0 %>% 
  filter(subject_identifier_S1 != subject_identifier_S2) %>% 
  mutate(comparison= paste0(MIA_CMV_Seropositivity_S1, " vs ", MIA_CMV_Seropositivity_S2)) %>% 
  group_by(S2, comparison) %>% 
  summarise(within.mean.dist=mean(value, na.rm = TRUE)) %>% 
  filter(comparison %in% c("1 vs 1","2 vs 2")) %>% 
  mutate_at(c("comparison"), list(~factor(.))) %>%
  as.data.frame() 

## reorder factors
influ.corr.T0_CMV$comparison <- factor(influ.corr.T0_CMV$comparison, levels = c("2 vs 2", "1 vs 1"))

## heterogeneity in CMV differences
kruskal.test(within.mean.dist ~ comparison, data = influ.corr.T0_CMV) 

kw.test.all <- influ.corr.T0_CMV %>% 
  kruskal_test(within.mean.dist ~ comparison) %>% 
  adjust_pvalue(method = "BH") 
kw.test.all.eff.size <- influ.corr.T0_CMV %>% 
  kruskal_effsize(within.mean.dist ~ comparison) 
combine.kw <- kw.test.all %>% left_join(kw.test.all.eff.size, by=".y.") %>%
  filter(p.adj < 0.05)

### Post-hoc analysis dunn's test
dun.test.pos <- influ.corr.T0_CMV %>% dunn_test(within.mean.dist ~ comparison, p.adjust.method = "BH", detailed = TRUE)
dun.test.pos <- dun.test.pos %>% filter(p.adj.signif != "ns")
head(dun.test.pos)

## plot heterogeneity in CMV differences + statistics
p3 <- influ.corr.T0_CMV %>% 
  ggplot( aes(x=comparison, y=within.mean.dist)) +
  geom_boxplot(aes(fill=comparison), alpha=0.9,outlier.size=0,outlier.colour="white") +
  geom_jitter(aes(fill=comparison), alpha=0.2, width = 0.3, shape=21,size=1) +
  scale_fill_manual(values = c("#E69F00","#56B4E9"),name = "CMV status", labels = c("CMV-", "CMV+"))+
  theme_classic()+
  xlab("")+
  ylab("Intra-group correlation (Spearman's r)")+
  theme(legend.position='none')+
  stat_summary()+
  stat_pvalue_manual(dun.test.pos, y.position = max(influ.corr.T0_CMV$within.mean.dist), step.increase = 0.05,label = "p.adj.signif",hide.ns = TRUE)+
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
p3

pdf(file = paste0(heterogeneity.dir,"Heterogeneity_T0_influ_intra_CMV_ada_inn.pdf"), width = 3.5 , height = 3.5); p3 ; dev.off()
```

### calculate heterogeneity, intra-group, EBV (in CMV-) Figure 3F
```{r}
## calculate correlations within the groups, (CMV-EBV+ - CMV-EBV-)
influ.corr.T0_CMVEBV <- influ.corr_T0 %>% 
  filter(subject_identifier_S1 != subject_identifier_S2) %>% 
  filter(CMV_EBV_combined_S1 %in% c("CMV-EBV+","CMV-EBV-")) %>%
  mutate(comparison= paste0(CMV_EBV_combined_S1, " vs ", CMV_EBV_combined_S2)) %>% 
  group_by(S2, comparison) %>% 
  summarise(within.mean.dist=mean(value, na.rm = TRUE))%>% 
  filter(comparison %in% c("CMV-EBV- vs CMV-EBV-","CMV-EBV+ vs CMV-EBV+")) %>% 
  mutate_at(c("comparison"), list(~factor(.))) %>%
  as.data.frame() 

## reorder factors
influ.corr.T0_CMVEBV$comparison <- factor(influ.corr.T0_CMVEBV$comparison, levels = c("CMV-EBV- vs CMV-EBV-","CMV-EBV+ vs CMV-EBV+"))


## heterogeneity in EBV differences
kruskal.test(within.mean.dist ~ comparison, data = influ.corr.T0_CMVEBV) 

kw.test.all <- influ.corr.T0_CMVEBV %>% 
  kruskal_test(within.mean.dist ~ comparison) %>% 
  adjust_pvalue(method = "BH") 
kw.test.all.eff.size <- influ.corr.T0_CMVEBV %>% 
  kruskal_effsize(within.mean.dist ~ comparison) 
combine.kw <- kw.test.all %>% left_join(kw.test.all.eff.size, by=".y.") %>%
  filter(p.adj < 0.05)

### Post-hoc analysis dunn's test
dun.test.pos <- influ.corr.T0_CMVEBV %>% dunn_test(within.mean.dist ~ comparison, p.adjust.method = "BH", detailed = TRUE)
dun.test.pos <- dun.test.pos %>% filter(p.adj.signif != "ns")
head(dun.test.pos)

## plot heterogeneity in EBV differences + statistics
p4 <- influ.corr.T0_CMVEBV %>% 
  ggplot( aes(x=comparison, y=within.mean.dist)) +
  geom_boxplot(aes(fill=comparison), alpha=0.9,outlier.size=0,outlier.colour="white") +
  geom_jitter(aes(fill=comparison), alpha=0.2, width = 0.3, shape=21,size=1) +
  scale_fill_manual(values = c("#E69F00","#56B4E9"),name = "EBV status (in CMV-)")+
  theme_classic()+
  theme(legend.position='none')+
  xlab("")+
  ylab("Intra-group correlation (Spearman's r)")+
  stat_summary()+
  stat_pvalue_manual(dun.test.pos, y.position = max(influ.corr.T0_CMVEBV$within.mean.dist), step.increase = 0.05,label = "p.adj.signif",hide.ns = TRUE)+
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
p4

pdf(file = paste0(heterogeneity.dir,"Heterogeneity_T0_influ_intra_CMV-EBV+_CMV-EBV-_ada_inn.pdf"), width = 4.5 , height = 4.5); p4 ; dev.off()
```

### align the plots and save
```{r}
ggarrange_4 <- egg::ggarrange(p2,p1,p3,p4,widths = c(3,2,2,2), ncol = 4)
pdf(file = paste0(heterogeneity.dir, "Heterogeneity_ggarrange_ada_inn.pdf", sep=""),width = 8 , height = 2.5); ggarrange_4; dev.off()
```

# Permutational Multivariate Analysis of Variance (PERMANOVA)
### data organization
```{r}
set.seed(935934)
## using influenza T0 clustered data #####
## join CVI & immune data
Dat_permanova <- vital.truc_influ_d0_cluster %>% 
  left_join(chronic_viral_inf, by="subject_identifier") %>% 
  select(-c(fcs_file,subject_identifier,sample_identifier,timepoint, timepoint_days))

## Subset participant and immune data ####
## Get participant data
participant.data_T0 <- Dat_permanova[,c(1:4,211:217)] %>% 
  as.data.frame()
head(participant.data_T0)
 
## Get immune data
immune.data_T0 <- Dat_permanova[,-c(1:4,211:217)] %>% 
  as.data.frame()
head(immune.data_T0)

## make sample ids rownames
rownames(immune.data_T0) <- Dat_permanova$sample_identifier
rownames(participant.data_T0) <- Dat_permanova$sample_identifier
```

### permanova analysis
#### Age
```{r}
adon1 <- adonis(formula = immune.data_T0 ~ age,
                method = "canberra", 
               data = participant.data_T0, permutations = 1000)
adon1
```

#### immunotypes
```{r}
## clusters
adon2 <- adonis(formula = immune.data_T0 ~ cluster_number,
                method = "canberra", 
               data = participant.data_T0, permutations = 1000)
adon2
```

#### Sex
```{r}
## sex differences
adon4 <- adonis(formula = immune.data_T0 ~ sex,
                method = "canberra", 
               data = participant.data_T0, permutations = 1000)
adon4
```

#### CMV
```{r}
### remove borderline cases first
Dat_permanova_sub <- Dat_permanova %>% 
  filter(MIA_CMV_Seropositivity %in% c("1","2"))

participant.data_T0_sub <- Dat_permanova[,c(1:4,211:217)] %>% 
  as.data.frame()
immune.data_T0_sub <- Dat_permanova[,-c(1:4,211:217)] %>%
  as.data.frame()

### make sample ids rownames
rownames(immune.data_T0_sub) <- Dat_permanova$sample_identifier
rownames(participant.data_T0_sub) <- Dat_permanova$sample_identifier

## CMV permanova
adon3 <- adonis(formula = immune.data_T0_sub ~ MIA_CMV_Seropositivity,
                method = "canberra", 
               data = participant.data_T0_sub, permutations = 1000)
adon3
```

#### EBV
```{r}
### remove borderline cases first
Dat_permanova_sub<-Dat_permanova %>% filter(MIA_EBV_Seropositivity %in% c("1","2"))

participant.data_T0_sub <- Dat_permanova[,c(1:4,211:217)] %>% 
  as.data.frame()
immune.data_T0_sub <- Dat_permanova[,-c(1:4,211:217)] %>%
  as.data.frame()
## make sample ids rownames
rownames(immune.data_T0_sub) <- Dat_permanova$sample_identifier
rownames(participant.data_T0_sub) <- Dat_permanova$sample_identifier

adon5 <- adonis(formula = immune.data_T0_sub ~ MIA_EBV_Seropositivity,
                method = "canberra", 
               data = participant.data_T0_sub, permutations = 1000)
adon5
```

#### CMV, EBV combined
```{r}
## CMV-EBV together, remove borderline
Dat_permanova_sub<-Dat_permanova %>% filter(CMV_EBV_combined %!in% c("Borderline"))

participant.data_T0_sub <- Dat_permanova[,c(1:4,211:217)] %>% 
  as.data.frame()
immune.data_T0_sub <- Dat_permanova[,-c(1:4,211:217)] %>% 
  as.data.frame()
## make sample ids rownames
rownames(immune.data_T0_sub) <- Dat_permanova$sample_identifier
rownames(participant.data_T0_sub) <- Dat_permanova$sample_identifier

adon6 <- adonis(formula = immune.data_T0_sub ~ CMV_EBV_combined,
                method = "canberra", 
               data = participant.data_T0_sub, permutations = 1000)
adon6
```


